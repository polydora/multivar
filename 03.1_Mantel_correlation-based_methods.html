<!DOCTYPE html>
<html>
<head>
  <title>Анализ связи между наборами данных</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="generator" content="pandoc" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <base target="_blank">

  <script type="text/javascript">
    var SLIDE_CONFIG = {
      // Slide settings
      settings: {
                title: 'Анализ связи между наборами данных',
                        useBuilds: true,
        usePrettify: true,
        enableSlideAreas: true,
        enableTouch: true,
                        favIcon: '03.1_Mantel_correlation-based_methods_files/logo.png',
              },

      // Author information
      presenters: [
            {
        name:  'Вадим Хайтов, Марина Варфоломеева' ,
        company: '',
        gplus: '',
        twitter: '',
        www: '',
        github: ''
      },
            ]
    };
  </script>

  <script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
  <link href="site_libs/ioslides-13.5.1/fonts/fonts.css" rel="stylesheet" />
  <link href="site_libs/ioslides-13.5.1/theme/css/default.css" rel="stylesheet" />
  <link href="site_libs/ioslides-13.5.1/theme/css/phone.css" rel="stylesheet" />
  <script src="site_libs/ioslides-13.5.1/js/modernizr.custom.45394.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/prettify/prettify.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/prettify/lang-r.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/prettify/lang-yaml.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/hammer.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/slide-controller.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/slide-deck.js"></script>

  <style type="text/css">

    b, strong {
      font-weight: bold;
    }

    em {
      font-style: italic;
    }

    summary {
      display: list-item;
    }

    slides > slide {
      -webkit-transition: all 0.4s ease-in-out;
      -moz-transition: all 0.4s ease-in-out;
      -o-transition: all 0.4s ease-in-out;
      transition: all 0.4s ease-in-out;
    }

    .auto-fadein {
      -webkit-transition: opacity 0.6s ease-in;
      -webkit-transition-delay: 0.4s;
      -moz-transition: opacity 0.6s ease-in 0.4s;
      -o-transition: opacity 0.6s ease-in 0.4s;
      transition: opacity 0.6s ease-in 0.4s;
      opacity: 0;
    }
/* https://github.com/ropensci/plotly/pull/524#issuecomment-468142578 */
slide:not(.current) .plotly.html-widget{
  display: block;
}

    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
            pre > code.sourceCode { white-space: pre; position: relative; }
            pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
            pre > code.sourceCode > span:empty { height: 1.2em; }
            .sourceCode { overflow: visible; }
            code.sourceCode > span { color: inherit; text-decoration: inherit; }
            div.sourceCode { margin: 1em 0; }
            pre.sourceCode { margin: 0; }
            @media screen {
            div.sourceCode { overflow: auto; }
            }
            @media print {
            pre > code.sourceCode { white-space: pre-wrap; }
            pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
            }
            pre.numberSource code
              { counter-reset: source-line 0; }
            pre.numberSource code > span
              { position: relative; left: -4em; counter-increment: source-line; }
            pre.numberSource code > span > a:first-child::before
              { content: counter(source-line);
                position: relative; left: -1em; text-align: right; vertical-align: baseline;
                border: none; display: inline-block;
                -webkit-touch-callout: none; -webkit-user-select: none;
                -khtml-user-select: none; -moz-user-select: none;
                -ms-user-select: none; user-select: none;
                padding: 0 4px; width: 4em;
                color: #aaaaaa;
              }
            pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
            div.sourceCode
              {   }
            @media screen {
            pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
            }
            code span.al { color: #ff0000; font-weight: bold; } /* Alert */
            code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
            code span.at { color: #7d9029; } /* Attribute */
            code span.bn { color: #40a070; } /* BaseN */
            code span.bu { color: #008000; } /* BuiltIn */
            code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
            code span.ch { color: #4070a0; } /* Char */
            code span.cn { color: #880000; } /* Constant */
            code span.co { color: #60a0b0; font-style: italic; } /* Comment */
            code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
            code span.do { color: #ba2121; font-style: italic; } /* Documentation */
            code span.dt { color: #902000; } /* DataType */
            code span.dv { color: #40a070; } /* DecVal */
            code span.er { color: #ff0000; font-weight: bold; } /* Error */
            code span.ex { } /* Extension */
            code span.fl { color: #40a070; } /* Float */
            code span.fu { color: #06287e; } /* Function */
            code span.im { color: #008000; font-weight: bold; } /* Import */
            code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
            code span.kw { color: #007020; font-weight: bold; } /* Keyword */
            code span.op { color: #666666; } /* Operator */
            code span.ot { color: #007020; } /* Other */
            code span.pp { color: #bc7a00; } /* Preprocessor */
            code span.sc { color: #4070a0; } /* SpecialChar */
            code span.ss { color: #bb6688; } /* SpecialString */
            code span.st { color: #4070a0; } /* String */
            code span.va { color: #19177c; } /* Variable */
            code span.vs { color: #4070a0; } /* VerbatimString */
            code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
        
    slides > slide:not(.nobackground):before {
      font-size: 12pt;
      content: "";
      position: absolute;
      bottom: 20px;
      left: 60px;
      background: url(03.1_Mantel_correlation-based_methods_files/logo.png) no-repeat 0 50%;
      -webkit-background-size: 30px 30px;
      -moz-background-size: 30px 30px;
      -o-background-size: 30px 30px;
      background-size: 30px 30px;
      padding-left: 40px;
      height: 30px;
      line-height: 1.9;
    }
  </style>

  <link rel="stylesheet" href="assets/my_styles.css" type="text/css" />

</head>

<body style="opacity: 0">

<slides class="layout-widescreen">

  <slide class="title-slide segue nobackground">
        <aside class="gdbar"><img src="03.1_Mantel_correlation-based_methods_files/logo.png"></aside>
        <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
    <hgroup class="auto-fadein">
      <h1 data-config-title><!-- populated from slide_config.json --></h1>
      
      <p data-config-presenter><!-- populated from slide_config.json --></p>
          </hgroup>
  </slide>

<style>
div#before-column p.forceBreak {
    break-before: column;
}
div#after-column p.forceBreak {
    break-after: column;
}
</style>

<slide class=""><hgroup><h2>Вы сможете</h2></hgroup><article  id="вы-сможете">

<ul>
<li>Количественно оценить степень взаимосвязи между несколькими наборами данных.</li>
<li>Протестировать гипотезу о наличии в данных некоторого специфического паттерна, используя метод модельных матриц.</li>
<li>Найти оптимальное сочетание признаков, не вошедших в ординацию, которые &ldquo;объясняют&rdquo; характер взаиморасположения точек на ординации</li>
</ul>

</article></slide><slide class=""><hgroup><h2>Ординация растительности на пастбищах северных оленей</h2></hgroup><article  id="ординация-растительности-на-пастбищах-северных-оленей" class="smaller columns-2">

<p>Данные из работы<br/>Väre, H., Ohtonen, R. and Oksanen, J. (1995)</p>

<p><img src="images/Vare%20et%20al%201995%20map.png" style="height:330px;"></p>

<p><small>из Väre, Ohtonen &amp; Oksanen (1995)</small></p>

<p><br><br><br ></p>

<pre class = 'prettyprint lang-r'>library(vegan)
library(ggplot2)
data(varespec)
data(varechem)</pre>

<p>Два набора данных:</p>

<ul>
<li><code>varespec</code> - Описание растительности (обилия отдельных видов)</li>
<li><code>varechem</code> - Параметры среды на участках (Концентрации веществ)</li>
</ul>

<p><br /><br /><br /><br /><br /><br /><br /></p>

</article></slide><slide class=""><hgroup><h2>Задание</h2></hgroup><article  id="задание">

<ol>
<li>Используя средства пакета &ldquo;ggplot2&rdquo;, постройте ординацию описаний растительности в осях MDS.</li>
<li>Раскрасьте точки в соответствии с концентрацией Al.</li>
<li>На диаграмме приведите величину стресса для данной ординации</li>
</ol>

<p>Hint. В качестве меры различия используйте коэффициент Брея-Куртиса</p>

</article></slide><slide class=""><hgroup><h2>Решение</h2></hgroup><article  id="решение" class="columns-2 smaller">

<!-- ```{r, eval=FALSE} -->

<!-- veg_ord <- metaMDS(varespec, trace = 0) -->

<!-- veg_MDS <- as.data.frame(veg_ord$points) -->

<!-- ``` -->

<!-- ```{r message=FALSE, eval=FALSE} -->

<!-- library(ggplot2) -->

<!-- Pl_mds <-  -->

<!--   ggplot(veg_MDS, aes(x = MDS1, y = MDS2,  -->

<!--                     fill = varechem$Al))  + -->

<!--   geom_point(shape=21, size =4)+ -->

<!--   ggtitle(paste("Stress = ", round(veg_ord$stress, 2))) +  -->

<!--   theme_bw() + -->

<!--   theme(legend.position = "bottom") + -->

<!--   labs(fill = "Aluminium concentration") + -->

<!--   scale_fill_gradient(high = "red", low = "yellow")  -->

<!-- ``` -->

<pre class = 'prettyprint lang-r'>veg_ord &lt;- metaMDS(varespec, trace = FALSE)
veg_MDS &lt;- as.data.frame(veg_ord$points)</pre>

<pre class = 'prettyprint lang-r'>library(ggplot2)
Pl_mds &lt;- 
  ggplot(veg_MDS, aes(x = MDS1, y = MDS2, 
                    fill = varechem$Al))  +
  geom_point(shape=21, size =4)+
  ggtitle(paste(&quot;Stress = &quot;, round(veg_ord$stress, 2))) + 
  theme_bw() +
  theme(legend.position = &quot;bottom&quot;) +
  labs(fill = &quot;Aluminium concentration&quot;) +
  scale_fill_gradient(high = &quot;red&quot;, low = &quot;yellow&quot;) </pre>

<p><br /><br /><br /><br /><br /><br /><br /></p>

<p><br /><br /><br /><br /><br /><br /><br /></p>

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/unnamed-chunk-4-1.png" width="480" style="display: block; margin: auto;" /></p>

</article></slide><slide class=""><hgroup><h2>Анализ связи с переменными c помощью функции envfit()</h2></hgroup><article  id="анализ-связи-с-переменными-c-помощью-функции-envfit">

<p><strong>Задание</strong>: Постройте рисунок, который будет отражать связь полученной ординации с изученными переменными среды (датасет <code>varechem</code>)</p>

</article></slide><slide class=""><hgroup><h2>Решение</h2></hgroup><article  id="решение-1" class="columns-2 smaller">

<pre class = 'prettyprint lang-r'>env_fit &lt;- envfit(veg_ord ~ ., data = varechem)</pre>

<pre class = 'prettyprint lang-r'>ordiplot(veg_ord, display = &quot;site&quot;)
plot(env_fit)</pre>

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/unnamed-chunk-6-1.png" width="432" style="display: block; margin: auto;" /></p>

</article></slide><slide class=""><hgroup><h2>Анализ связи с переменными c помощью функции ordisurf()</h2></hgroup><article  id="анализ-связи-с-переменными-c-помощью-функции-ordisurf">

<p><strong>Задание</strong>: Постройте рисунок, который будет отражать связь полученной ординации с концентрацией Mn и Al</p>

</article></slide><slide class=""><hgroup><h2>Решение</h2></hgroup><article  id="решение-2" class="smaller columns-2">

<pre class = 'prettyprint lang-r'>env_fit2 &lt;- envfit(veg_ord ~ Al + Mn, data = varechem)
plot(veg_ord, display = &quot;site&quot;)
plot(env_fit2, col = &quot;red&quot;)
ordisurf(veg_ord, varechem$Al, add = TRUE, col=&quot;blue&quot;)
ordisurf(veg_ord, varechem$Mn, add = TRUE, col=&quot;green&quot;)</pre>

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/unnamed-chunk-8-1.png" width="480" style="display: block; margin: auto;" /></p>

<p><strong>Вопрос:</strong><br/>Сможем ли мы на основе данных, полученных с помощью функций <code>envfit()</code> или <code>ordisurf()</code>, построить оптимальную модель, описывающую связь структуры сообществ и параметров среды?</p>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Тест Мантела</h2></hgroup><article  id="тест-мантела">

</article></slide><slide class=""><hgroup><h2>Постановка проблемы</h2></hgroup><article  id="постановка-проблемы">

<p>Нам необходимо оценить связаны ли, в целом, два набора данных и оценить силу этой связи</p>

<p><strong>Похожие задачи</strong></p>

<blockquote>
<p>Зависит ли растительность от параметров среды?<br/>Связаны ли морфологические признаки и экспрессия генов?<br/>Связаны ли характеристики паразитов и хозяев?</p>
</blockquote>

<p>и т.п.</p>

</article></slide><slide class=""><hgroup><h2>Метод сравнения сопряженных матриц, описывающих попарные расстояния (или сходства), был предложен Натаном Мантелом</h2></hgroup><article  id="метод-сравнения-сопряженных-матриц-описывающих-попарные-расстояния-или-сходства-был-предложен-натаном-мантелом">

<center>

<img src="images/Mantel.png" style="height:350px;">

</center>

</article></slide><slide class=""><hgroup><h2>Корреляция матриц сходства/различия</h2></hgroup><article  id="корреляция-матриц-сходстваразличия" class="smaller">

<p>Если две матрицы сопряжены, то меры сходства/различия в одной матрице должны быть подобны мерам сходства/различия в другой матрице</p>

<pre class = 'prettyprint lang-r'>dist_com &lt;- vegdist(varespec, method = &quot;bray&quot;)
dist_chem &lt;- vegdist(varechem, method = &quot;euclidean&quot;)</pre>

<pre >## `geom_smooth()` using formula &#39;y ~ x&#39;</pre>

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/unnamed-chunk-10-1.png" width="480" style="display: block; margin: auto;" /></p>

</article></slide><slide class=""><hgroup><h2>Корреляция матриц сходства/различия</h2></hgroup><article  id="корреляция-матриц-сходстваразличия-1">

<p><img src="images/Mantel%20princip.png" style="height:400px;"></p>

<p>Вопрос: Как можно определить статистическую значимость полученного коэффициента корреляции?</p>

<ul class = 'build'>
<li>Внимание! Значимость этой корреляции нельзя оценивать как для обычной корреляции, например функцией <code>cor.test()</code> или по таблице пороговых значений коэффициента корреляции.</li>
</ul>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Пермутационные методы оценки статистической значимости</h2></hgroup><article  id="пермутационные-методы-оценки-статистической-значимости" class="smaller">

<p style="text-align:right">

– Друг мой, – отвечал Диоталлеви, – ты никогда ничего не поймешь. Да, это правда, что Тора – я имею в виду, разумеется, видимую Тору – есть лишь одна из перестановок-<em>пермутаций</em> букв, составляющих вековечную Тору, какою создал ее Творец и какой ее дал Адаму. Умберто Эко<br/>&ldquo;Маятник Фуко&rdquo;

</p>

</article></slide><slide class=""><hgroup><h2>Тестирование простейшей гипотезы</h2></hgroup><article  id="тестирование-простейшей-гипотезы">

<p>Создадим две выборки из популяций с нормальным распределением признака, с заведомо отличающимися средними значениями</p>

<pre class = 'prettyprint lang-r'>set.seed(12345)

male &lt;- rnorm(100, 130, 5)
female &lt;- rnorm(100, 129,5)</pre>

</article></slide><slide class=""><hgroup><h2>Частотное распределение этих двух выборок выглядит так</h2></hgroup><article  id="частотное-распределение-этих-двух-выборок-выглядит-так">

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>

</article></slide><slide class=""><hgroup><h2>Сравним две выборки с помощью t-критерия Стьюдента</h2></hgroup><article  id="сравним-две-выборки-с-помощью-t-критерия-стьюдента">

<p>Какая статистика используется в t-критерии?</p>

<ul class = 'build'>
<li>\(t= \frac {X1-X2} {SE}\)</li>
</ul>

</article></slide><slide class=""><hgroup><h2>Сравним две выборки с помощью t-критерия Стьюдента</h2></hgroup><article  id="сравним-две-выборки-с-помощью-t-критерия-стьюдента-1">

<p>Результаты</p>

<pre class = 'prettyprint lang-r'>t &lt;- t.test(male, female)
t</pre>

<pre >## 
##  Welch Two Sample t-test
## 
## data:  male and female
## t = 3, df = 196, p-value = 0.009
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  0.516 3.484
## sample estimates:
## mean of x mean of y 
##       131       129</pre>

<p>Что означает выражение p-value=0.009?</p>

</article></slide><slide class=""><hgroup><h2>Пермутационный подход к тестированию</h2></hgroup><article  id="пермутационный-подход-к-тестированию">

<p>Если две сравниваемые выборки взяты из одной совокупности (справедлива \(H_0\)), то обмен элементами между ними ничего не изменит. Степень различия между выборками (значение статистики) останется более или менее тем же самым.</p>

<p class="forceBreak">

</p>

<p><strong>Пермутации - это перестановки.</strong></p>

<p>Полное количество пермутаций (при равном количестве объектов в двух группах) будет вычисляться по следующей формуле:</p>

<p>\[K= \frac{(2n)!}{(2!(n!)^2)}\]</p>

<p>При большом объеме выборок это огромное число!</p>

<p>В таких случаях используют метод Монте-Карло.</p>

</article></slide><slide class=""><hgroup><h2>Пермутационный метод вручную</h2></hgroup><article  id="пермутационный-метод-вручную">

<p>Применим этот метод (на очень примитивном уровне) к нашим двум выборкам, описывающим размеры мальчиков и девочек (векторы male и female).</p>

<pre class = 'prettyprint lang-r'>head (male)</pre>

<pre >## [1] 133 134 129 128 133 121</pre>

<pre class = 'prettyprint lang-r'>head (female)</pre>

<pre >## [1] 130 123 131 122 130 126</pre>

</article></slide><slide class=""><hgroup><h2>Пермутационный метод вручную</h2></hgroup><article  id="пермутационный-метод-вручную-1">

<p>Введем статистику</p>

<p>\[t= \frac {X_1 - X_2}{ \sqrt {SE_1^2+SE_2^2}}\]</p>

<p>Вычислим значение этой статистики при сравнении векторов male и female</p>

<pre class = 'prettyprint lang-r'>SE_m &lt;- sd(male) / sqrt(length(male))
SE_f &lt;- sd(female) / sqrt(length(female))
t_initial &lt;- (mean(male) - mean(female))/sqrt(SE_m^2 + SE_f^2)</pre>

<p>Полученное значение t = 2.657</p>

</article></slide><slide class=""><hgroup><h2>Пермутационный метод вручную</h2></hgroup><article  id="пермутационный-метод-вручную-2">

<p>При пермутациях мы должны поменять местами, например, male[10] = 125.403 и female[20] = 128.655. А еще лучше поменять случайное количество элементов одной выборки на случайное количество элементов из другой выборки.</p>

<pre class = 'prettyprint lang-r'>f &lt;- female
m &lt;- male
num_perm &lt;- sample(1:100,1)
order_m &lt;- sample (1:100, num_perm)
order_f &lt;- sample (1:100, num_perm)
f[order_f] &lt;- male[order_f]
m[order_m] &lt;- female[order_f]
SE_m &lt;- sd(m) / sqrt(length(m))
SE_f &lt;- sd(f) / sqrt(length(f))
t_p=(mean(m) - mean(f))/sqrt(SE_m^2 + SE_f^2)</pre>

<p>После этой пермутации у нас получилось значение \(t_{perm}\) = -2.332, а исходное значение было t = 2.657</p>

</article></slide><slide class=""><hgroup><h2>Пермутационный метод вручную</h2></hgroup><article  id="пермутационный-метод-вручную-3">

<p>Теперь нужно провести процедуру пермутации много раз и получить распределение значений статистики \(t_{perm}\)</p>

<pre class = 'prettyprint lang-r'>Nperm=10000
tperm &lt;- rep(NA, Nperm)

set.seed(12345)
for (i in 1:(Nperm-1)) 
  {
  BOX &lt;- c(male,female)
  ord &lt;-sample(1:200, 200)
  f &lt;- BOX[ord[1:100]]
  m &lt;- BOX [ord[101:200]]
  SE_m &lt;- sd(m) / sqrt(length(m))
  SE_f &lt;- sd(f) / sqrt(length(f))
  tperm[i]=(mean(m) - mean(f))/sqrt(SE_m^2 + SE_f^2)
  }
head(tperm)</pre>

<pre >## [1] -0.508 -0.420 -2.240 -0.781  0.901 -1.152</pre>

</article></slide><slide class=""><hgroup><h2>Пермутационный метод вручную</h2></hgroup><article  id="пермутационный-метод-вручную-4">

<p>Посмотрим в конец этого вектора</p>

<pre class = 'prettyprint lang-r'>tail (tperm)</pre>

<pre >## [1] -0.4985  1.6344 -0.7864 -0.0249  1.0292      NA</pre>

<p>Последнее 10000-е значение не заполнено!<br/>В него надо вписать исходное, полученное до пермутаций, значение t = 2.657. Это необходимо, так как мы тестируем гипотезу о принадлежности этого значения случайному распределению.</p>

<pre class = 'prettyprint lang-r'>tperm [Nperm] &lt;- t_initial</pre>

</article></slide><slide class=""><hgroup><h2>Пермутационный метод вручную</h2></hgroup><article  id="пермутационный-метод-вручную-5">

<p>Построим частотное распределение пермутированных значений статистики \(t_{perm}\)</p>

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/unnamed-chunk-20-1.png" width="672" style="display: block; margin: auto;" /></p>

</article></slide><slide class=""><hgroup><h2>Пермутационный метод вручную</h2></hgroup><article  id="пермутационный-метод-вручную-6">

<p>Рассчитаем величину уровня значимости \(p_{perm}= \frac{N_{t_{perm}&gt;=t}}{N_{perm}}\)</p>

<pre class = 'prettyprint lang-r'>p_perm &lt;- length(tperm[tperm &gt;= t_initial] | tperm[tperm &lt;= -t_initial] ) / Nperm</pre>

<p>Мы получили уровень значимости \(p_{perm}\) = 0.005</p>

<p>Сравним его с уровнем значимости, вычисленным с помощью параметрического t-критерия p=0.009</p>

<p>Они оба близки и оба выявляют значимые различия!</p>

</article></slide><slide class=""><hgroup><h2>Пермутационная оценка коэффициента корреляции</h2></hgroup><article  id="пермутационная-оценка-коэффициента-корреляции">

<p>Создадим два скоррелированных вектора</p>

<pre class = 'prettyprint lang-r'>library(MASS)
set.seed(1234567)
mu &lt;- c(10, 20) #Вектор средних значений
Sigma &lt;- matrix(.7, nrow=2, ncol=2) 
diag(Sigma) &lt;- c(1, 3)

# Sigma Ковариационная матрица

dat &lt;- as.data.frame(mvrnorm(n=100, mu=mu, Sigma=Sigma)) 
# Датафрейм с двумя скоррелированными переменными

cor.test(dat$V1, dat$V2, method = &quot;spearman&quot;)</pre>

<pre >## 
##  Spearman&#39;s rank correlation rho
## 
## data:  dat$V1 and dat$V2
## S = 87860, p-value = 0.0000009
## alternative hypothesis: true rho is not equal to 0
## sample estimates:
##   rho 
## 0.473</pre>

</article></slide><slide class=""><hgroup><h2>Пермутационная оценка коэффициента корреляции</h2></hgroup><article  id="пермутационная-оценка-коэффициента-корреляции-1">

<pre class = 'prettyprint lang-r'>library(coin)</pre>

<pre >## Loading required package: survival</pre>

<pre class = 'prettyprint lang-r'>spearman_test( V1 ~ V2, data = dat, distribution = approximate(B=9999))</pre>

<pre >## 
##  Approximative Spearman Correlation Test
## 
## data:  V1 by V2
## Z = 5, p-value &lt;0.0001
## alternative hypothesis: true rho is not equal to 0</pre>

</article></slide><slide class=""><hgroup><h2>Проверка статистической значимости Мантеловской корреляции</h2></hgroup><article  id="проверка-статистической-значимости-мантеловской-корреляции" class="smaller">

<p>Для оценки достоверности Мантеловской корреляции применяется пермутационная процедура. Эта процедура реализована в функции <code>mantel()</code> из пакета <code>vegan</code></p>

<pre class = 'prettyprint lang-r'>options(digits=4)
mant &lt;- mantel(dist_com, dist_chem, method=&quot;pearson&quot;, permutations = 999)
mant</pre>

<pre >## 
## Mantel statistic based on Pearson&#39;s product-moment correlation 
## 
## Call:
## mantel(xdis = dist_com, ydis = dist_chem, method = &quot;pearson&quot;,      permutations = 999) 
## 
## Mantel statistic r: 0.182 
##       Significance: 0.027 
## 
## Upper quantiles of permutations (null model):
##   90%   95% 97.5%   99% 
## 0.109 0.150 0.184 0.202 
## Permutation: free
## Number of permutations: 999</pre>

<p>Вероятность наблюдать такое значение при условии, что верна \(H_0\), равна 0.027</p>

</article></slide><slide class=""><hgroup><h2>Частная Мантеловская корреляция</h2></hgroup><article  id="частная-мантеловская-корреляция" class="columns-2">

<p><img src="images/Vare%20et%20al%201995%20map.png" style="height:350px;"></p>

<p><small>из Väre, Ohtonen &amp; Oksanen (1995)</small></p>

<p>В материале есть одна проблема</p>

<ul class = 'build'>
<li>сходство между отдельными описаниями может быть обусловлено не только их биологическими свойствами, но и тем, что они просто располагаются ближе друг к другу в пространстве.<br/></li>
<li>Корреляция между биологическими признаками и химическими должна оцениваться при учете еще одной матрицы - <strong>Матрицы географических расстояний</strong></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Частная Мантеловская корреляция</h2></hgroup><article  id="частная-мантеловская-корреляция-1" class="smaller">

<pre class = 'prettyprint lang-r'>mantel_partial &lt;- mantel.partial(xdis = dist_com, ydis = dist_chem, zdis = dist_geo, method = &quot;pearson&quot;, permutations = 9999)
mantel_partial</pre>

<pre >## 
## Partial Mantel statistic based on Pearson&#39;s product-moment correlation 
## 
## Call:
## mantel.partial(xdis = dist_com, ydis = dist_chem, zdis = dist_geo,      method = &quot;pearson&quot;, permutations = 9999) 
## 
## Mantel statistic r: 0.182 
##       Significance: 0.023 
## 
## Upper quantiles of permutations (null model):
##   90%   95% 97.5%   99% 
## 0.113 0.144 0.178 0.215 
## Permutation: free
## Number of permutations: 9999</pre>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Подбор оптимальной модели: процедура BIO-ENV</h2></hgroup><article  id="подбор-оптимальной-модели-процедура-bio-env">

</article></slide><slide class=""><hgroup><h2>Постановка задачи</h2></hgroup><article  id="постановка-задачи">

<p>Необходимо выбрать предикторы, которые наилучшим образом объясняют поведение биологической системы.</p>

<p>\(NB!\) Эта задача аналогична задачам, ставящимся в регрессионном анализе.</p>

<p>К. Кларком и M. Эйнсвортом был предложен метод BIO-ENV (Clarke, Ainsworth, 1993). Это непараметрический аналог пошагового регрессионного анализа.</p>

</article></slide><slide class=""><hgroup><h2>Процедура BIO-ENV</h2></hgroup><article  id="процедура-bio-env">

<p>В этом анализе есть две сцепленные матрицы:</p>

<ul class = 'build'>
<li>Зависимая матрица (BIO) - матрица геоботанических описаний.</li>
<li>Матрица-предиктор (ENV) - матрица химических параметров.</li>
</ul>

</article></slide><slide class=""><hgroup><h2>Алгоритм процедуры BIO-ENV</h2></hgroup><article  id="алгоритм-процедуры-bio-env">

<ul class = 'build'>
<li>Вычисляется матрица взаимных расстояний между объектами для зависимой матрицы \(D_{BIO}\). Используются все ее переменные.</li>
<li>Матрица-предиктор имеет \(p\) переменных. Вычисляются все возможные матрицы взаимных расстояний между объектами для всех возможных комбинаций признаков матрицы ENV - \(D_{ENV_i}\). ВНИМАНИЕ! Таких матриц будет \(2^p-1\).</li>
<li>Между каждой из матриц \(D_{ENV_i}\) и матрицей \(D_{BIO}\) вычисляется мантеловская корреляция.</li>
<li>Находится матрица \(D_{ENV_i}\), имеющая максимальное значение мантеловской корреляции.</li>
<li>Выводятся признаки матрицы ENV, на основе которых получена максимально подобная матрица \(D_{ENV_i}\).</li>
</ul>

</article></slide><slide class=""><hgroup><h2>Функция bioenv() из пакета vegan</h2></hgroup><article  id="функция-bioenv-из-пакета-vegan">

<pre class = 'prettyprint lang-r'>BioEnv &lt;- bioenv(varespec, varechem, method = &quot;spearman&quot;, index = &quot;bray&quot;)</pre>

<pre >## 16383 possible subsets (this may take time...)</pre>

<pre class = 'prettyprint lang-r'>BioEnv</pre>

<pre >## 
## Call:
## bioenv(comm = varespec, env = varechem, method = &quot;spearman&quot;,      index = &quot;bray&quot;) 
## 
## Subset of environmental variables with best correlation to community data.
## 
## Correlations:    spearman 
## Dissimilarities: bray 
## Metric:          euclidean 
## 
## Best model has 5 parameters (max. 14 allowed):
## N P Al Mn Baresoil
## with correlation  0.4494</pre>

</article></slide><slide class=""><hgroup><h2>Оценка достоверности результатов</h2></hgroup><article  id="оценка-достоверности-результатов">

<p><strong>Внимание!</strong> Не надо оценивать достоверность результата процедуры BIO-ENV путем оценки достоверности мантеловской корреляции между \(D_{BIO}\) и матрицей, полученной в результате применения BIO-ENV \(D_{ENV}\). <strong>Это будет жульничеством</strong>, так как это уже максимально подобная матрица. <br /><br /> Для оценки достоверности полученного результата применяется пермутационный метод, основанный на <strong>многократном повторении самой процедуры BIO-ENV</strong>. <br /><br /> Внимание! Это занимает очень много времени</p>

</article></slide><slide class=""><hgroup><h2>Алгоритм оценки достоверности применения процедуры BIO-ENV</h2></hgroup><article  id="алгоритм-оценки-достоверности-применения-процедуры-bio-env" class="columns-2">

<p><img src="images/BIOENV.png" style="height:450px;"></p>

<ol>
<li>Применяем процедуру BIO-ENV и находим лучшее сочетание переменных в матрице-предикторе (ENV).</li>
<li>Пермутируем зависимую матрицу (BIO).</li>
<li>Применяем процедуру BIO-ENV к пермутированной матрице и вновь находим наилучшее сочетание и записываем значение мантеловской корреляции.</li>
<li>Повторяя шаги 2 и 3 многократно, получаем распределение пермутационных статистик.</li>
<li>Вычисляем уровень значимости способом, принятым при пермутационной оценке.</li>
</ol>

</article></slide><slide class=""><hgroup><h2>Трактовка результатов BIO-ENV?</h2></hgroup><article  id="трактовка-результатов-bio-env">

<p>Задание: Постройте ординацию описаний в осях nMDS и отразите на этой диаграмме векторы, соответствующие результатам процедуры <code>BIO-ENV</code></p>

</article></slide><slide class=""><hgroup><h2>Решение</h2></hgroup><article  id="решение-3">

<pre class = 'prettyprint lang-r'>plot(veg_ord, display = &quot;site&quot;)
plot(envfit(veg_ord ~ N + P + Al + Mn + Baresoil, data = varechem ))</pre>

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/unnamed-chunk-28-1.png" width="672" style="display: block; margin: auto;" /></p>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Тестирование гипотезы о соответствии ожидаемому паттерну: метод модельных матриц</h2></hgroup><article  id="тестирование-гипотезы-о-соответствии-ожидаемому-паттерну-метод-модельных-матриц">

</article></slide><slide class=""><hgroup><h2>Пример: Динамика сообществ мидиевых банок</h2></hgroup><article  id="пример-динамика-сообществ-мидиевых-банок" class="columns-2">

<p>Существуют ли направленные многолетние изменения в размерной структуре поселений мидий и в структуре сообщества (Khaitov, 2013)?</p>

<pre class = 'prettyprint lang-r'>com &lt;- read.csv(&quot;data/mussel_beds.csv&quot;, 
                sep=&#39;;&#39;, header = T)

ascam &lt;- read.csv(&quot;data/ASCAM.csv&quot;, 
                  sep=&#39;;&#39;, header = T)</pre>

<p><code>com</code> — усредненные данные по обилию 12 видов для 3 мидиевых банок (Vor2, Vor4, Vor5).</p>

<p><code>ascam</code> — (averaged size class abundance matrix) средние плотности поселения мидий разных размеров (6] размерных классов)</p>

<p><img src="images/musselbed.png" width="450" height="350" alt="Мидиевая банка"></p>

</article></slide><slide class=""><hgroup><h2>Задание</h2></hgroup><article  id="задание-1" class="columns-2 smaller">

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/dynam-2-1.png" width="480" style="display: block; margin: auto;" /></p>

<p>Рассмотрите многолетние изменения структуры сообщества и размерной структуры мидий на мидиевой банке Vor2</p>

<p>Постройте рисунок, аналогичный приведенному на данном слайде</p>

<p>Hint 1. Прологарифмируйте данные.</p>

<p>Hint 2. Примените наиболее подходящий коэффициент для оценки различий между объектами.</p>

</article></slide><slide class=""><hgroup><h2>Решение</h2></hgroup><article  id="решение-4">

<h3>Ординация</h3>

<pre class = 'prettyprint lang-r'>library(vegan)

log_com &lt;- decostand(com[,-c(1:3)], method = &quot;log&quot;)

vor2_log_com &lt;- log_com[com$Bank == &quot;Vor2&quot;,]

log_ascam &lt;- decostand(ascam[, -c(1:2)], method = &quot;log&quot;)

mds_vor2_com &lt;- as.data.frame(metaMDS(vor2_log_com)$points)

vor2_log_ascam &lt;- log_ascam[ascam$Bank == &quot;Vor2&quot;,]

mds_vor2_ascam &lt;- as.data.frame(metaMDS(vor2_log_ascam, distance = &quot;euclid&quot; )$points)</pre>

</article></slide><slide class=""><hgroup><h2>Решение</h2></hgroup><article  id="решение-5">

<h3>График ординации</h3>

<pre class = 'prettyprint lang-r'>library(ggplot2)
library(gridExtra)
theme_set(theme_bw())

Pl1 &lt;- ggplot(mds_vor2_com, aes(x=MDS1, y=MDS2)) + geom_point() + 
  geom_path() + geom_text(label = com$Year[com$Bank == &quot;Vor2&quot;]) + 
  ggtitle(&quot;Динамика сообщества&quot;)

Pl2 &lt;- ggplot(mds_vor2_ascam, aes(x=MDS1, y=MDS2)) + geom_point() + 
  geom_path() + geom_text(label = com$Year[com$Bank == &quot;Vor2&quot;]) + 
  ggtitle(&quot;Динамика размерной структуры&quot;)

grid.arrange(Pl1, Pl2)</pre>

</article></slide><slide class=""><hgroup><h2>Градиентная модельная матрица</h2></hgroup><article  id="градиентная-модельная-матрица" class="smaller">

<p>Это матрица Евклидовых расстояний между временными точками.</p>

<pre class = 'prettyprint lang-r'>gradient_model &lt;- vegdist(com$Year[com$Bank == &quot;Vor2&quot;], method=&quot;euclidian&quot;)
gradient_model </pre>

<pre >##     1  2  3  4  5  6  7  8  9 10 11 12 13 14
## 2   1                                       
## 3   2  1                                    
## 4   3  2  1                                 
## 5   4  3  2  1                              
## 6   5  4  3  2  1                           
## 7   6  5  4  3  2  1                        
## 8   7  6  5  4  3  2  1                     
## 9   8  7  6  5  4  3  2  1                  
## 10  9  8  7  6  5  4  3  2  1               
## 11 10  9  8  7  6  5  4  3  2  1            
## 12 11 10  9  8  7  6  5  4  3  2  1         
## 13 12 11 10  9  8  7  6  5  4  3  2  1      
## 14 13 12 11 10  9  8  7  6  5  4  3  2  1   
## 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1</pre>

</article></slide><slide class=""><hgroup><h2>Тестируем гипотезу о наличии градиента</h2></hgroup><article  id="тестируем-гипотезу-о-наличии-градиента">

<p>Протестируем гипотезу о наличии временного градиента с помощью теста Мантела</p>

<pre class = 'prettyprint lang-r'>dist_vor2_com &lt;- vegdist(vor2_log_com, method = &quot;bray&quot;)
dist_vor2_ascam &lt;- vegdist(vor2_log_ascam, method = &quot;euclidean&quot;)</pre>

<h3>1) Наличие градиента в структуре сообщества</h3>

<pre class = 'prettyprint lang-r'>mantel(dist_vor2_com, gradient_model)</pre>

<pre >## 
## Mantel statistic based on Pearson&#39;s product-moment correlation 
## 
## Call:
## mantel(xdis = dist_vor2_com, ydis = gradient_model) 
## 
## Mantel statistic r: 0.264 
##       Significance: 0.028 
## 
## Upper quantiles of permutations (null model):
##   90%   95% 97.5%   99% 
## 0.180 0.221 0.265 0.315 
## Permutation: free
## Number of permutations: 999</pre>

</article></slide><slide class=""><hgroup><h2>Тестируем гипотезу о наличии градиента</h2></hgroup><article  id="тестируем-гипотезу-о-наличии-градиента-1">

<h3>2) Наличие градиента в размерной структуре мидий</h3>

<pre class = 'prettyprint lang-r'>mantel(dist_vor2_ascam, gradient_model)</pre>

<pre >## 
## Mantel statistic based on Pearson&#39;s product-moment correlation 
## 
## Call:
## mantel(xdis = dist_vor2_ascam, ydis = gradient_model) 
## 
## Mantel statistic r: 0.516 
##       Significance: 0.001 
## 
## Upper quantiles of permutations (null model):
##   90%   95% 97.5%   99% 
## 0.161 0.218 0.262 0.312 
## Permutation: free
## Number of permutations: 999</pre>

</article></slide><slide class=""><hgroup><h2>Прослеживается ли связь между размерной структурой мидий и структурой сообщества?</h2></hgroup><article  id="прослеживается-ли-связь-между-размерной-структурой-мидий-и-структурой-сообщества">

<h3>Не самое правильное решение</h3>

<pre class = 'prettyprint lang-r'>mantel(dist_vor2_com, dist_vor2_ascam)</pre>

<pre >## 
## Mantel statistic based on Pearson&#39;s product-moment correlation 
## 
## Call:
## mantel(xdis = dist_vor2_com, ydis = dist_vor2_ascam) 
## 
## Mantel statistic r: 0.521 
##       Significance: 0.009 
## 
## Upper quantiles of permutations (null model):
##   90%   95% 97.5%   99% 
## 0.304 0.383 0.440 0.501 
## Permutation: free
## Number of permutations: 999</pre>

</article></slide><slide class=""><hgroup><h2>Прослеживается ли связь между размерной структурой мидий и структурой сообщества?</h2></hgroup><article  id="прослеживается-ли-связь-между-размерной-структурой-мидий-и-структурой-сообщества-1">

<h3>Более корректное решение</h3>

<pre class = 'prettyprint lang-r'>mantel.partial(dist_vor2_com, dist_vor2_ascam, gradient_model)</pre>

<pre >## 
## Partial Mantel statistic based on Pearson&#39;s product-moment correlation 
## 
## Call:
## mantel.partial(xdis = dist_vor2_com, ydis = dist_vor2_ascam,      zdis = gradient_model) 
## 
## Mantel statistic r: 0.465 
##       Significance: 0.025 
## 
## Upper quantiles of permutations (null model):
##   90%   95% 97.5%   99% 
## 0.297 0.386 0.460 0.532 
## Permutation: free
## Number of permutations: 999</pre>

</article></slide><slide class=""><hgroup><h2>Могут быть и более сложные модельные матрицы</h2></hgroup><article  id="могут-быть-и-более-сложные-модельные-матрицы" class="columns-2">

<p>Проверим, нет ли в динамике размерной структуры мидий на банке Vor2 циклических изменений, которые предсказываются некоторыми моделями динамики плотных поселений (Наумов, 2006; Khaitov, Lentsman, 2016)</p>

<p><img src="03.1_Mantel_correlation-based_methods_files/figure-html/unnamed-chunk-36-1.png" width="384" style="display: block; margin: auto;" /></p>

<p>Циклическая модельная матрица</p>

<pre >##    1 2 3 4 5 6 7 8 9 10 11 12 13 14
## 2  0                               
## 3  1 0                             
## 4  1 1 0                           
## 5  1 1 1 0                         
## 6  2 1 1 1 0                       
## 7  2 2 1 1 1 0                     
## 8  2 2 2 1 1 1 0                   
## 9  2 2 2 2 1 1 1 0                 
## 10 2 2 2 2 2 1 1 1 0               
## 11 2 2 2 2 2 2 1 1 1  0            
## 12 1 2 2 2 2 2 2 1 1  1  0         
## 13 1 1 2 2 2 2 2 2 1  1  1  0      
## 14 1 1 1 2 2 2 2 2 2  1  1  1  0   
## 15 0 1 1 1 2 2 2 2 2  2  1  1  1  0</pre>

</article></slide><slide class=""><hgroup><h2>Выявляется ли циклическая составляющая в динамике размерной структуры?</h2></hgroup><article  id="выявляется-ли-циклическая-составляющая-в-динамике-размерной-структуры">

<pre class = 'prettyprint lang-r'>mantel(dist_vor2_ascam, cycl_model)</pre>

<pre >## 
## Mantel statistic based on Pearson&#39;s product-moment correlation 
## 
## Call:
## mantel(xdis = dist_vor2_ascam, ydis = cycl_model) 
## 
## Mantel statistic r: 0.173 
##       Significance: 0.011 
## 
## Upper quantiles of permutations (null model):
##    90%    95%  97.5%    99% 
## 0.0912 0.1213 0.1396 0.1721 
## Permutation: free
## Number of permutations: 999</pre>

<p>Циклическая составляющая есть, но…</p>

</article></slide><slide class=""><hgroup><h2>Более корректная оценка</h2></hgroup><article  id="более-корректная-оценка">

<pre class = 'prettyprint lang-r'>mantel.partial(dist_vor2_ascam, cycl_model, gradient_model)</pre>

<pre >## 
## Partial Mantel statistic based on Pearson&#39;s product-moment correlation 
## 
## Call:
## mantel.partial(xdis = dist_vor2_ascam, ydis = cycl_model, zdis = gradient_model) 
## 
## Mantel statistic r: -0.137 
##       Significance: 0.94 
## 
## Upper quantiles of permutations (null model):
##   90%   95% 97.5%   99% 
## 0.111 0.142 0.177 0.198 
## Permutation: free
## Number of permutations: 999</pre>

<p>Мы не можем говорить о наличии столь длительного цикла.</p>

<p>При данной длине временного ряда нельзя отличить цикл с большим периодом от направленного изменения.</p>

<p>Можно обсуждать только циклы с периодом не более половины длины временного ряда.</p>

<!-- ## Модельные матрицы и ANOSIM -->

<!-- При проверке гипотезы о значимости различий между группами можно использовать тест Мантела. В этой ситуации модельная матрица будет содержать 0, если расстояние внутригрупповое, и 1 если расстояние межгрупповое.  -->

<!-- ```{r} -->

<!-- m <- vegdist(as.numeric(com$Bank), method = "euclidean")  -->

<!-- mm <- m -->

<!-- mm[m > 0] <- 1 -->

<!-- mm[m == 0] <- 0 -->

<!-- mantel(vegdist(log_com), mm, method = "pearson") -->

<!-- ``` -->

<!-- Значения теста Мантела будут очень близки к $R_{global}$ -->

</article></slide><slide class=""><hgroup><h2>Summary</h2></hgroup><article  id="summary">

<ul>
<li>Степень сопряженности двух наборов признаков можно оценивать с помощью теста Мантела.</li>
<li>Оценка достоверности теста Мантела и корреляций с признаками, вычисленными в процедуре <code>envfit()</code> проводится пермутационным методом</li>
<li>С помощью процедуры <code>BIO-ENV</code> можно выявить набор переменных в матрице-предикторе, которые обеспечивают наибольшее сходство с зависимой матрицей.</li>
</ul>

</article></slide><slide class=""><hgroup><h2>Другое программное обеспечение</h2></hgroup><article  id="другое-программное-обеспечение">

<p>PRIMER 6.</p>

<p>Здесь реализована расширенная процедура <code>BEST</code>.<br/>Она позволяет проводить не только полный перебор всех переменных в матрице-предикторе (Bio-Env), но и оптимизировать эту процедуру (BVStep). Кроме того, есть возможность оценивать достоверность результатов анализа. Но работает так же медленно.</p>

</article></slide><slide class=""><hgroup><h2>Что почитать</h2></hgroup><article  id="что-почитать">

<ul>
<li>Oksanen, J., 2011. Multivariate analysis of ecological communities in R: vegan tutorial. R package version 2–0.</li>
<li>Clarke, K. R &amp; Ainsworth, M. 1993. A method of linking multivariate community structure to environmental variables. Marine Ecology Progress Series, 92, 205–219.</li>
<li>Clarke, K. R., Gorley R. N. (2006) PRIMER v6: User Manual/Tutorial. PRIMER-E, Plymouth.</li>
<li>Legendre P., Legendre L. (2012) Numerical ecology. Second english edition. Elsevier, Amsterdam. (В этом издании приводятся ссылки на реализацию методов в R)</li>
</ul></article></slide>


  <slide class="backdrop"></slide>

</slides>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!-- map slide visiblity events into shiny -->
<script>
  (function() {
    if (window.jQuery) {
       window.jQuery(document).on('slideleave', function(e) {
         window.jQuery(e.target).trigger('hidden');
      });
       window.jQuery(document).on('slideenter', function(e) {
         window.jQuery(e.target).trigger('shown');
      });
    }
  })();
</script>

</body>
</html>
