---
title: "ANOSIM и SIMPER"
subtitle: "Анализ и визуализация многомерных данных с использованием R"
author: Вадим Хайтов, Марина Варфоломеева
presenters: [{
    name: 'Вадим Хайтов',
    company: 'Каф. Зоологии беспозвоночных, СПбГУ',
    }]
output:
 ioslides_presentation:
  widescreen: true
  css: assets/my_styles.css
  logo: assets/Linmod_logo.png
---

## Вы сможете

 
- Протестировать гипотезу о различиях между дискретными группами многомерных данных с помощью теста ANOSIM  
- Выявить переменные, вносящие наибольший вклад в формирование различий между группами, применив процедуру SIMPER  

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.align='center', tidy = FALSE, fig.width = 7, fig.height = 3, warning = FALSE)
```

## Вспомним основы {.columns-2 }

<img src="images/underwood.png" width="450" height="450" alt="Underwood, 1997">
       

Этапы работы с гипотезами (Underwood, 1997)

Формулировка биологической гипотезы  

Численное выражение биологической гипотезы ($H$)  

Формулировка альтернативной гипотезы ($H_0$ - нулевой гипотезы)  

Тестирование нулевой гипотезы  


Если $H_0$ ложна, то признаем, что верна $H$ и, следовательно, биологическую гипотезу можно рассматривать как истинное утверждение  

Если $H_0$ истинна, то…  


#Пермутационные методы тестирования

##Тестирование простейшей гипотезы
Создадим две выборки из популяций с нормальным распределением признака, с заведомо отличающимися средними значениями

```{r}
set.seed(12345)

male <- rnorm(100, 130, 5)
female <- rnorm(100, 129,5)
```

##Частотное распределение этих двух выборок выглядит так
```{r, echo=FALSE, fig.height=5, fig.width=7, message=FALSE}
library(ggplot2)
size <- data.frame(L=1:200, gender=1:100)
size$L <- male
size$gender <- "m"
size$L[101:200] <- female
size$gender[101:200] <- "f"
size$gender <- as.factor(size$gender)
pl <- ggplot(size, aes(x=L, ..density..))
pl <- pl + theme_bw()  + geom_histogram(binwidth = 5, fill = "gray", color = "black") + facet_grid(gender~.) 
pl 
```

##Сравним две выборки с помощью t-критерия Стьюдента

Какая статистика используется в t-критерии?

>- $t= \frac {X1-X2} {SE}$

##Сравним две выборки с помощью t-критерия Стьюдента

Результаты

```{r}
t <- t.test(male, female)
t
```


Что означает выражение p-value=`r t$p.value`?


##Пермутационный подход к тестированию

Если две сравниваемые выборки взяты из одной совокупности (справедлива $H_0$), то обмен элементами между ними ничего не изменит. Степень различия между выборками (значение статистики) останется более или менее тем же самым.   

Пермутации - это перестановки.

Полное количество пермутаций (при равном количестве объектов в двух группах) будет вычисляться по следующей формуле: 
$$K= \frac{(2n)!}{(2!(n!)^2)}$$

При большом объеме выборок это огромное число! 

В таких случаях используют метод Монте-Карло. 

##Пермутационный метод вручную

Применим этот метод (на очень примитивном уровне) к нашим двум выборкам, описывающим размеры мальчиков и девочек (векторы male и female). 


```{r}
head (male)
head (female)
```

##Пермутационный метод вручную

Введем статистику 

$$t= \frac {X_1 - X_2}{ \sqrt {SE_1^2+SE_2^2}}$$

Вычислим значение этой статистики при сравнении векторов male и female


```{r}
SE_m <- sd(male) / sqrt(length(male))
SE_f <- sd(female) / sqrt(length(female))
t_initial <- (mean(male) - mean(female))/sqrt(SE_m^2 + SE_f^2)
```


Полученное значение t = `r t_initial`


##Пермутационный метод вручную

При пермутациях мы должны поменять местами, например, male[10] = `r male[10]` и female[20] = `r female[20]`. А еще лучше поменять случайное количество элементов одной выборки на случайное количество элементов из другой выборки.


```{r}
f <- female
m <- male
num_perm <- sample(1:100,1)
order_m <- sample (1:100, num_perm)
order_f <- sample (1:100, num_perm)
f[order_f] <- male[order_f]
m[order_m] <- female[order_f]
SE_m <- sd(m) / sqrt(length(m))
SE_f <- sd(f) / sqrt(length(f))
t_p=(mean(m) - mean(f))/sqrt(SE_m^2 + SE_f^2)
```

После этой пермутации у нас получилось значение $t_{perm}$ = `r t_p`, а исходное значение было t = `r t_initial` 



##Пермутационный метод вручную

Теперь нужно провести процедуру пермутации много раз и получить распределение значений статистики $t_{perm}$      

```{r, echo=TRUE}
Nperm=10000
tperm <- rep(NA, Nperm)

set.seed(12345)
for (i in 1:(Nperm-1)) 
  {
  BOX <- c(male,female)
  ord <-sample(1:200, 200)
  f <- BOX[ord[1:100]]
  m <- BOX [ord[101:200]]
  SE_m <- sd(m) / sqrt(length(m))
  SE_f <- sd(f) / sqrt(length(f))
  tperm[i]=(mean(m) - mean(f))/sqrt(SE_m^2 + SE_f^2)
  }
head(tperm)
```


##Пермутационный метод вручную

Посмотрим в конец этого вектора

```{r}
tail (tperm)
```

Последнее 10000-е значение не заполнено!   
В него надо вписать исходное, полученное до пермутаций, значение t = `r t_initial`. Это необходимо, так как мы тестируем гипотезу о принадлежности этого значения случайному распределению.

```{r}
tperm [Nperm] <- t_initial
```


##Пермутационный метод вручную

Построим частотное распределение пермутированных значений статистики $t_{perm}$

```{r, echo=FALSE,fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
tperm <- as.data.frame(tperm)
names(tperm) <- "t_p" 
tperm_pl <- ggplot(tperm, aes(x=t_p))
tperm_pl <- tperm_pl + geom_histogram (bin=0.4, fill="blue", colour="black") + theme_bw() + xlab("Пермутационные значения статистики") + geom_vline(xintercept=c(t_initial, -t_initial), linetype=2)

tperm_pl
```


##Пермутационный метод вручную


Рассчитаем величину уровня значимости $p_{perm}= \frac{N_{t_{perm}>=t}}{N_{perm}}$


```{r, warning=FALSE}
p_perm <- length(tperm[tperm >= t_initial] | tperm[tperm <= -t_initial] ) / Nperm
```

Мы получили уровень значимости $p_{perm}$ = `r p_perm` 

Сравним его с уровнем значимости, вычисленным с помощью параметрического t-критерия p=`r t$p.value`

Они оба близки и оба выявляют достоверные различия!






# ANOSIM: Analysis Of Similarity

## Пример: Динамика сообществ мидиевых банок {.columns-2}

Существуют ли различия в сообществах мидиевых банок, сформированных старыми и молодыми мидиями (Khaitov, 2013)?

<img src="images/musselbed.png" width="450" height="350" alt="Мидиевая банка">


```{r, echo=TRUE}
com <- read.csv("data/mussel_beds.csv", sep=';', header = T)
ascam <- read.csv("data/ASCAM.csv", sep=';', header = T)
```

`com` --- усредненные данные по обилию `r ncol(com[,-c(1:3)])` видов для 3 мидиевых банок (Vor2, Vor4, Vor5).  

`ascam` --- (averaged size class abundance matrix) средние плотности поселения мидий разных размеров (`r ncol(ascam[, -c(1:2)])`] размерных классов) 




## Задание

- Постройте ординацию всех описаний датасета `com` (прологарифмированные данные) в осях nMDS на основе матрицы Брея-Куртиса
- Раскрасьте разными цветами точки, относящиеся к двум разным группам: "Large-dominated" и "Small-dominated"


## Решение

```{r}
library(vegan)
library(ggplot2)

log_com <- log(com[,-c(1:3)] + 1)

ord_log_com <- metaMDS(log_com, distance = "bray", k=2, trace = 0)
MDS <- data.frame(ord_log_com$points)

```

## Решение

Обратите внимание, здесь есть две группы расстояний между точками

```{r, fig.width=10, fig.height=4}
ggplot(MDS, aes(x = MDS1, y = MDS2, fill = com$Mussel_size)) + geom_point(shape = 21, size = 4) + scale_fill_manual(values = c("red", "blue")) + labs(fill = "Mussel size structure type") + ggtitle(paste("Stress = ", round(ord_log_com$stress, 3), sep = " "))
```

## Расстояния между объектами {.columns-2}

### 1. Внутригрупповые расстояния 

![Within group distance](images/witnin group distances.png)

<br />

### 2. Межгрупповые расстояния

![between group distance](images/Between groups distances.png)


## Ранги расстояний

Для работы удобно (но не обязательно!) перейти от исходных расстояний между объектами, к их рангам.

Обозначим внутригрупповые расстояния (ранги), как $r_w$, а межгрупповые, как $r_b$.

Вычислим  

* средние значения внутригрупповых рангов расстояний $R_w$
* средние значения межгрупповых рангов расстояний $R_b$


## R - статистика

На основе полученных значений можно построить статистику (Clarke, 1988, 1993)

$$R_{global} = \frac{R_b-R_w}{n(n-1)/4}$$

Эта статистика распределена в интервале -1 < $R_{global}$ < 1

Статистическая значимость этой величины оценивается пермутационным методом


## Процедура ANOSIM в пакете `vegan`

```{r}
com_anosim <- anosim(log_com, 
           grouping = com$Mussel_size, 
           permutations = 999, 
           distance = "bray")
```


## Задание

Изучите структуру объекта `com_anosim` и постройте частотное распределение значений $R_{global}$, полученных при каждом акте пермутации

## Решение

```{r r-global, eval=FALSE}
anosim_perm <- data.frame(perm = com_anosim$perm)
anosim_perm[(com_anosim$permutations + 1), 1] <- com_anosim$statistic
ggplot(anosim_perm, aes(x = perm)) + geom_histogram(binwidth = 0.01, color = "black", fill = "blue") + geom_vline(xintercept = com_anosim$statistic, linetype = 2)
```

## Результаты оценки статистики $R_{global}$ при пермутациях

```{r r-global, eval=TRUE, echo=FALSE}
```

## Результаты процедуры ANOSIM

```{r}
summary(com_anosim)
```

## Ограничения (Assumptions) для применения ANOSIM

### 1) Внутригрупповые расстояния (ранги) должны иметь приблизительно равные медианы и пределы варьирования.

Для проверки этого допущения надо сравнить распределения внутригрупповых и межгрупповых расстояний (рангов)

Распределение расстояний имеет следующий вид

```{r fig.width=5, fig.height=3.5, warning=FALSE}
plot(com_anosim, main = "Dissimilarity ranks \n between and within classes")
```

## ANOSIM позволяет сравнивать одновременно и несколько групп

НО! Есть одно очень важное ограничение: 

### 2) Попарные сравненения групп можно осуществлять только если было показано, что $R_{global}$ статистически значимо.

Если это условие выполнено, то можно проводить попарные сравнения

### Пример

Пусть у нас есть три группы объектов: A, B, C.  
Можно вычислить $R_{A vs B}$, $R_{A vs C}$, $R_{B vs C}$.


Но при больших объемах выборки даже незначительные различия будут достоверны. Важно обращать внимание не только на оценку статистической значимости, но и на значения R! 

NB! Для сравнения нескольких групп многомерных объектов, есть более мощное средство - PERMANOVA 


## Задание

+ Постройте ординацию в осях nMDS, раскрасив точки в разные цвета в зависимости от номера мидиевой банки
+ Проверьте гипотезу о различиях в структуре сообществ на разных банках
+ Проверьте условия применимости ANOSIM
+ Проведите попарное сравнение всех банок


## Решение

### График ординации

```{r fig.height = 4, fig.width=5}
ggplot(MDS, aes(x = MDS1, y = MDS2, fill = com$Bank)) + geom_point(shape = 21, size = 4) + scale_fill_manual(values = c("red", "blue", "green")) + labs(fill = "Mussel beds") + ggtitle(paste("Stress = ", round(ord_log_com$stress, 3), sep = " "))
```

## Решение

### Проверка гипотезы о различиях в структуре сообществ на разных банках

```{r}
bed_anosim <- anosim(log_com, grouping = com$Bank,permutations = 999, distance = "bray")
bed_anosim
```

## Решение

### Условия применимости

```{r}
plot(bed_anosim)
```

## Решение

### Попарные сравнения Vor2 vs Vor4

```{r}
# Vor2 vs Vor4
anosim(log_com [com$Bank %in% c("Vor2", "Vor4"),], 
    grouping = com$Bank[com$Bank %in% c("Vor2", "Vor4")])
```

## Попарные сравнения Vor2 vs Vor5

```{r}
# Vor2 vs Vor5
anosim(log_com[com$Bank %in% c("Vor2", "Vor5"),], grouping = com$Bank[com$Bank %in% c("Vor2", "Vor5")])
```

## Попарные сравнения Vor4 vs Vor5

```{r}
# Vor4 vs Vor5
anosim(log_com [com$Bank %in% c("Vor4", "Vor5"),], grouping = com$Bank[com$Bank %in% c("Vor4", "Vor5")])
```

## Проблема малых выборок

Мощность ANOSIM невелика.

При малых выборках пермутационная оценка уровня значимости может не выявить достоверных различий, даже при очень высоком значении R.





# SIMPER: Similarity Percentages

## Какие признаки зависимой матрицы вносят наибольший вклад в формирование различий между группами?

```{r, R.options=list(width = 80)}
log_com_simper <- simper(log_com, group = com$Mussel_size, permutations = 999)
summary (log_com_simper)
```

## Оценка вклада в формирование различий

$$Contr_i = \frac{|{y_{i,j}-y_{i,k}}|}{\sum{(y_{i,j}-y_{i,k})}}$$

Величины $Contr_i$ далее усредняются для всех межгрупповых пар 

$sd$ - среднеквадратичное отклонение

Отношение $Contr_i / sd$ характеризует дискриминирующую силу переменной

## Задание

Выявите виды, отвечающие за различия в сообществах разных банок

## Решение

```{r R.options=list(width = 80)}
summary(simper(log_com, group = com$Bank, permutations = 999 ))
```

## Summary

+ Помимо классических статистических тестов, можно применять тесты, основанные на пермутациях. 
+ ANOSIM --- простейший вариант сравнения нескольких групп объектов, охарактеризованных по многим признакам.
+ С помощью процедуры SIMPER можно оценить вклад отдельных переменных в формирование различий между группами. 


## Что почитать

* Clarke, K. R., Gorley R. N. (2006) PRIMER v6: User Manual/Tutorial. PRIMER-E, Plymouth.
* Legendre P., Legendre L. (2012) Numerical ecology. Second english edition. Elsevier, Amsterdam.
