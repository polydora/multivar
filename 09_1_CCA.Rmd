---
title: "Канонический корреспондентный анализ"
subtitle: "Анализ и визуализация многомерных данных с использованием R"
author: Вадим Хайтов, Марина Варфоломеева
presenters: [{
  name: 'Вадим Хайтов',
  company: 'Каф. Зоологии беспозвоночных, СПбГУ',
  }]
output:
 ioslides_presentation:
  widescreen: true
  css: assets/my_styles.css
  logo: assets/Linmod_logo.png
---

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.align='center', tidy = FALSE, fig.width = 7, fig.height = 3, warning = FALSE)
```

## Вы сможете

- Проводить канонический корреспондентный анализ
- Оценивать долю объясненной инерции
- Интерпретировать канонические оси по координатам переменных
- Строить ординацию объектов в пространстве канонических осей
- Проверять значимость модели ординации
- Разделять общую изменчивость на компоненты при помощи частного канонического корреспондентного анализа


## Связь нескольких наборов переменных: виды и среда {.columns-2 .smaller}

**Пример: ** клещи-орибатиды на сплавине одного из канадских озер

На площадке 10 х 2.6м взяли стратифицированную случайную выборку на 7 типах субстратов (70 проб). Исследователи хотели разделить влияние среды и положения в пространстве на структуру сообщества клещей-орибатид (Borcard & Legendre 1994).


![Oribatid mite](./images/OribatidMiteWithAVisitingFriendlySpringtail-AndyMurray-Flickr.jpg)

Oribatid mite with a visiting friendly springtail by [Andy Murray on Flickr](https://flic.kr/p/bqAFBs)

![Peat bog](./images/Tourbière_PeatBog-peupleloup-Flickr.jpg)

Tourbière/Peat bog* by [peupleloup on Flickr](https://flic.kr/p/51F8Ks)

* - peat bog - зыбун, сплавина (плавина)

##Читаем данные

```{r message = FALSE}
library(vegan)
data(mite)
data(mite.env)
data(mite.xy)
head(mite[ , 1:6], 2)
str(mite.xy)
str(mite.env)
```

##Схема асположения проб
```{r}
library(ggplot2)
library(gridExtra)
th <- theme(legend.text = element_text(size = 13), legend.title = element_text(size = 14), legend.position = "bottom", text = element_text(size = 10))
th_narrow <- th + theme(legend.key.width = unit(3, "mm"))

theme_set(theme_bw(base_size = 18))
update_geom_defaults("point", list(shape = 19))
p <- ggplot(mite.xy, aes(x = x, y = y)) + geom_point()
p + coord_fixed() + th
```

---

```{r mite-maps, echo = FALSE, message = FALSE, results='hide', fig.height = 6, fig.width = 14, cache=TRUE}
gginterp <- function(x, y, envir, nx, ny){
  # функция интерполирует значения переменных среды
  require(akima)
  require(reshape2)
  # Интерполяция
  fld <- interp.new(x = x, y = y, z = envir, xo=seq(min(x), max(x), length = nx), yo=seq(min(y), max(y), length = ny))
  # Перевод результатов в "длинную" форму
  df_env <- melt(fld$z, na.rm = TRUE)
  colnames(df_env) <- c("x", "y", "envir")
  # Замена по порядковым номерам настоящими значениями переменных среды
  df_env$x <- fld$x[df_env$x]
  df_env$y <- fld$y[df_env$y]
  return(df_env)
}

ggmapinterp <- function(x, y, envir, nx, ny){
  # функция рисует график интерполированной переменной
  df_env <- gginterp(x, y, envir, nx, ny)
  require(ggplot2)
  p <- ggplot(data = df_env, aes(x = x, y = y, z = envir)) +
    geom_tile(aes(fill = envir)) # + stat_contour(colour = "gray40")
  return(p)
}

# модификация темы для всех графиков
th <- theme(legend.text = element_text(size = 13), legend.title = element_text(size = 14), legend.position = "bottom", text = element_text(size = 10))
th_narrow <- th + theme(legend.key.width = unit(3, "mm"))

# Для легенды
p0 <- ggmapinterp(x = mite.xy$x, y = mite.xy$y, envir = mite.env$SubsDens, nx = 50, ny = 200) + geom_point(data = mite.xy, aes(x = x, y = y, z = NULL, shape = mite.env$Substrate)) + 
  scale_fill_continuous(name = "Плотность субстрата", low = "white", high = "green", guide = "none") +
  scale_shape_manual(name = "Субстрат", values=1:7, labels = c("Сфагн1", "Сфагн2", "Сфагн3", "Сфагн4", "Раст. остатки", "Голый торф", "Поверхность" )) + th

# Плотность субстрата
p1 <- ggmapinterp(x = mite.xy$x, y = mite.xy$y, envir = mite.env$SubsDens, nx = 50, ny = 200) + geom_point(data = mite.xy, aes(x = x, y = y, z = NULL, shape = mite.env$Substrate)) + scale_fill_continuous(low = "white", high = "green") +   scale_shape_manual(name = "Субстрат", values=1:7, labels = c("Сфагн1", "Сфагн2", "Сфагн3", "Сфагн4", "Раст. остатки", "Голый торф", "Поверхность" ), guide = "none") + th + ggtitle("Плотность\nсубстрата") + guides(fill = FALSE, shape = F)

# Содержание воды
p2 <- ggmapinterp(x = mite.xy$x, y = mite.xy$y, envir = mite.env$WatrCont, nx = 50, ny = 200) + geom_point(data = mite.xy, aes(x = x, y = y, z = NULL, shape = mite.env$Substrate)) + scale_fill_continuous( low = "white", high = "blue") +   scale_shape_manual(name = "Субстрат", values=1:7, labels = c("Сфагн1", "Сфагн2", "Сфагн3", "Сфагн4", "Раст. остатки", "Голый торф", "Поверхность" ), guide = "none") + th + ggtitle("Содержание\nводы") + guides(fill = FALSE, shape = F)

# Количество кустарников
p3 <- ggmapinterp(x = mite.xy$x, y = mite.xy$y, envir = mite.env$Shrub, nx = 50, ny = 200) +  geom_point(data = mite.xy, aes(x = x, y = y, z = NULL, shape = mite.env$Substrate)) +   scale_fill_continuous(low = "white", high = "darkgreen", breaks = c(1, 2, 3), labels = c("Нет", "Мало", "Много")) +   scale_shape_manual(name = "Субстрат", values=1:7, labels = c("Сфагн1", "Сфагн2", "Сфагн3", "Сфагн4", "Раст. остатки", "Голый торф", "Поверхность" ), guide = "none") + th + ggtitle("Покытие \nкустарники") + guides(fill = FALSE, shape = F)


p4 <- ggmapinterp(x = mite.xy$x, y = mite.xy$y, envir = mite.env$Topo, nx = 50, ny = 200) +  geom_point(data = mite.xy, aes(x = x, y = y, z = NULL, shape = mite.env$Substrate)) + scale_fill_continuous(low = "white", high = "orange", breaks = c(1, 2), labels = c("Ровно", "Кочка")) +  scale_shape_manual(name = "Субстрат", values=1:7, labels = c("Сфагн1", "Сфагн2", "Сфагн3", "Сфагн4", "Раст. остатки", "Голый торф", "Поверхность" ), guide = "none") + th + ggtitle("Топографические \nхарактеристики") + guides(fill = FALSE, shape = F)


#extract legend
#https://github.com/hadley/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

mylegend<-g_legend(p0 + theme(legend.position = "bottom", legend.key = element_blank()))

library(gridExtra)
grid.arrange(arrangeGrob(p1, p2, p3, p4, nrow = 1), mylegend, nrow = 2, heights = c(10, 1))
```

## Косвенный градиентный анализ

- ищем ось макс. варьирования (анализ главных компонент (PCA), корреспондентный анализ (CA))    
- затем строим регрессионную модель, описывающую связь PC или CA от интересующих нас предикторов 



>- Опасности:
  > - теряем связи переменных среды и отброшенных компонент высоких порядков. 
    - __Выход__ использовать прямой градиентный анализ.
  > - PCA нужны линейные зависимости (т.к. матрица ковариаций или корреляций). Если связи нелинейны - искривление градиентов.
    - __Выход__ использовать другие расстояния (CA использует хи-квадрат).

## Прямой градиентный анализ

Прямой градиентный анализ еще называют **каноническим** анализом.  

Происхождение термина **канонический**

Канонической формой функции или выражения в математике называют такую упрощенную  форму, к которой можно свести функцию или выражение без потери самой важной информации.   

Например, канонической формой матрицы ковариации является матрица собственных 
значений и собственных векторов.

В ординации каноническими осями будут такие оси, которые без потери большого количества информации, отражают связь объектов и признаков с некоторым набором предикторов.



## Канонический анализ

В общем виде каноничесий анализ сводится к тому же, что мы видели в CA и PCA, то есть к поиску собственных значений (задающих оси максимального варьирования) и собственных векторов (коэффициентов, определяющих координаты в новом пространстве).

НО! Оси ординации определяются еще и переменными среды.

Переменные среды ограничивают оси, поэтому канонические оси еще называют ограниченными осями (constrained axis)



##Принципиальная схема канонического анализа {.flexbox .vcenter .smaller} 


<img src="images/Canonical_analysis_scheme.png" width="400" height="500">
  
из Legendre & Legendre, 2012



## Вспомним регрессионный анализ


$$
\hat{y_i} = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \dots + \beta_px_{ip}
$$

Здесь
$\hat{y}$ - предсказанные значения (fitted values)

$x_1, x_2 \dots x_p$ - предикторы

$\beta_0, \beta_1, \beta_2 \dots + \beta_p$ - коэффициенты 

## Регрессионный анализ в матричном виде

Как всегда, независимая часть модели - это модельная матрица **X**   
Зависимая часть в анализе - это не вектор **y**, как мы привыкли, а матрица **Y**   
Коэффициенты, будут представлены тоже в виде матрицы $\beta$. 

Тогда матрица предсказанных значений

$$
\hat {\textbf Y}  = \boldsymbol {\beta \times  X}
$$

При этом матрица коэффициентов - это 

$$
\boldsymbol{\beta} = \boldsymbol {[X'X]^{-1}X'Y}
$$

Матрица остатков - это
$$
\boldsymbol {Y_{resid} = Y - \hat {Y}}
$$



## Канонический анализ и SVD

Таким образом на вход в канонический  анализ поступают три матрицы: $\boldsymbol{Y}$, $\boldsymbol{\hat{Y}}$, $\boldsymbol{Y_{resid}}$

   
1. SVD матрицы исходных значений ($\boldsymbol{Y}$) - дает информацию об общей изменчивости в системе - это просто СА (или PCA).     
2. SVD матрицы предсказанных значений ($\boldsymbol{\hat{Y}}$) - дает информацию о системе, ограниченной (Constrained) предикторами ($\boldsymbol{X}$).     
3. SVD матрицы остатков ($\boldsymbol{Y_{resid}}$) - дает информацию о системе за вычетом влияния предикторов.     


## Канонический корреспондентный анализ (CCA)

- Основан на корреспондентном анализе, то есть вместо исходных сырых, центрированных данных ($\boldsymbol{Y}$) используется матрица $\boldsymbol{Q}$ (Матрица вкладов в отклонение от нулевой модели, основанной на независимости между признаками и объектами).

<!-- - Мера изменчивости в этом анализе - $Inertia$. -->

<!-- - Нужно две матрицы данных: матрица зависимых переменных  и матрица предикторов. -->

<!-- - Нужно найти такие компоненты матрицы зависимых переменных, которые являются линейными комбинациями предикторов и отражают максимум инерции -->

### Условия применимости такие же как у CA


## Новые оси

- __Канонические__ - Корреспондентный анализ на основе матрицы предсказанных значений.
- __Неканонические__ - корреспондентный анализ таблицы остатков от регрессии координат по предикторам (каноническим осям) от переменных среды.

## Ординация в канонических и неканонических осях

Рассмотрение ординации в канонических осях дает информацию о связи между видами, сайтами и средой.

Анализ неканонических осей - отношения между видами или сайтами после того, как удален эффект среды.

## CCA - канонический кореспондентный анализ в vegan

- Зависимые переменные (отклики) - обилие видов

- Независимые переменные (предикторы) - переменные среды

## Задание
Используя представления об ограниченной ординации в форме RDA, постройте, по аналогии, ограниченную ординацию в форме CCA. Объект, содержащий результаты должен называться `mite_cca`

В качестве предикторов  в модели возьмите следующие факторы из датафрейма `mite.env`: SubsDens, WatrCont, Substrate, Topo



##Решение с помощью функции `cca()`
```{r, echo=TRUE}
mite_cca <- cca(mite ~ SubsDens + WatrCont + Substrate + Topo, data = mite.env)
```


##Проверяем предикторы на мультиколлинеарность

```{r}
vif.cca(mite_cca)
```




## Общая инерция и ее разложение

О ней можно судить __по суммам собственных чисел __ (ограниченных и неограниченных осей)


```
Partitioning of mean squared contingency coefficient:
              Inertia Proportion
Total           1.696      1.000
Constrained     0.735      0.433
Unconstrained   0.961      0.567
```

## Важность различных компонент 

Можно более подробно оценить, как распределяется изменчивость между осями в общем наборе осей. 


## Два типа осей {.smaller}

Канонические, или ограниченные, оси (CCA) и неканонические, или неограниченные, оси (CA)

```{r, eval=FALSE}
summary(mite_cca)
```

```
Importance of components:
                       CCA1  CCA2   CCA3   CCA4   CCA5    CCA6    CCA7    CCA8
Eigenvalue            0.426 0.129 0.0667 0.0443 0.0321 0.01447 0.01066 0.00821
Proportion Explained  0.251 0.076 0.0393 0.0261 0.0189 0.00853 0.00628 0.00484
Cumulative Proportion 0.251 0.327 0.3666 0.3927 0.4117 0.42020 0.42648 0.43132
                         CCA9    CA1   CA2    CA3    CA4    CA5    CA6    CA7    CA8
Eigenvalue            0.00357 0.1358 0.120 0.1127 0.0916 0.0639 0.0575 0.0451 0.0404
Proportion Explained  0.00211 0.0801 0.071 0.0664 0.0540 0.0377 0.0339 0.0266 0.0238
Cumulative Proportion 0.43343 0.5135 0.585 0.6510 0.7050 0.7426 0.7765 0.8031 0.8269
                         CA9   CA10   CA11   CA12   CA13   CA14   CA15    CA16
Eigenvalue            0.0329 0.0305 0.0286 0.0237 0.0207 0.0191 0.0172 0.01663
Proportion Explained  0.0194 0.0180 0.0168 0.0140 0.0122 0.0113 0.0101 0.00981
Cumulative Proportion 0.8463 0.8643 0.8811 0.8952 0.9073 0.9186 0.9287 0.93855
                         CA17    CA18    CA19    CA20    CA21    CA22    CA23
Eigenvalue            0.01439 0.01269 0.01260 0.00996 0.00846 0.00727 0.00642
Proportion Explained  0.00849 0.00748 0.00743 0.00587 0.00499 0.00429 0.00379
Cumulative Proportion 0.94703 0.95452 0.96195 0.96782 0.97281 0.97709 0.98088
                         CA24    CA25    CA26    CA27    CA28    CA29    CA30
Eigenvalue            0.00596 0.00551 0.00425 0.00374 0.00349 0.00272 0.00229
Proportion Explained  0.00351 0.00325 0.00251 0.00220 0.00206 0.00160 0.00135
Cumulative Proportion 0.98440 0.98765 0.99015 0.99236 0.99441 0.99602 0.99736
                         CA31    CA32     CA33     CA34
Eigenvalue            0.00192 0.00114 0.000991 0.000418
Proportion Explained  0.00113 0.00067 0.000580 0.000250
Cumulative Proportion 0.99850 0.99917 0.999750 1.000000
```

## Можно рассмотреть разложение инерции только в канонических осях


```
Accumulated constrained eigenvalues
Importance of components:
                       CCA1  CCA2   CCA3   CCA4   CCA5   CCA6 ...
Eigenvalue            0.426 0.129 0.0667 0.0443 0.0321 0.0145 ...
Proportion Explained  0.580 0.175 0.0907 0.0603 0.0437 0.0197 ...
Cumulative Proportion 0.580 0.755 0.8458 0.9061 0.9498 0.9695 ...

```

##Вопрос!

Сколько всего осей? 

>- Почему неканонических осей 34, а не 35?

>- А почему канонических осей 9?

# Механика работы CCA

##Вспомним вычисление CA вручную {.smaller}
```{r, echo=TRUE}
data(mite)

data(mite.env)

f_ij <- mite #Частота встречи данного вида в данной пробе, то есть это первичные даные!

Ft <- sum(mite) #Общее количество найденных животных

f_i <- apply(mite, 1, FUN = sum) #Общее количество особей в каждой пробе

p_i <- f_i/Ft #Вектор вероятностей встретить какую-либо особь в данной пробе

f_j <- apply(mite, 2, FUN = sum) #Общее количество особей в каждом виде

p_j <- f_j/Ft #Вектор вероятностей встретить особь данного вида

```


##Матрица вкладов

$$
\textbf{Q} = \frac {p_{ij} - p_ip_j}{\sqrt{p_ip_j}} = \frac{f_{ij}Ft - f_if_j}{Ft \sqrt{f_if_j}} 
$$


```{r}

#Матрица вкладов, вычисленная через частоты
Q <- (f_ij*Ft - f_i %*% t(f_j))/(Ft*sqrt(f_i %*% t(f_j))) 
Q <- as.matrix(Q)

```


##Сингулярное разложение матрицы вкладов

$$
\textbf{Q}_{n \times p} = \textbf{U}_{n \times p} \textbf{D}_{p \times p} \textbf{V}'_{p \times p} 
$$


```{r}
# SVD матрицы Q
U <- svd(Q)$u 
D <- diag(svd(Q)$d)
V <- svd(Q)$v

Inertia_total <- sum(D^2) #Общая инерция в системе
CA_number <- sum(round(D, 2) !=0) #Количество главныю осей в CA. Обратите внимание на то, что их на одну меньше, чем исходных колонок в матрице Q. 

```



## После применения Корреспондентного анализа мы знаем общее варьирование в системе 
Эта величина оценивается "инерцией"

Общая изменчивость в системе `r Inertia_total`   

Общее количество неканонических (unconstrained) осей `r CA_number`, как и положено, на одно меньше, чем  общее количество колонок в матрице **Q**, равное `r ncol(Q)`

НО! Почему ограниченных осей 9, хотя предикторов у нас всего 4?


##Связь между предикторами (параметрами среды) и зависимыми перменными (видами) {.smaller}

Для начала надо построить модельную матрицу
```{r, echo=TRUE}
X <- model.matrix(~SubsDens + WatrCont + Substrate + Topo, data =  mite.env) #Модельная матрица 

```

Количество столбцов в матрице **X** равно `r ncol(X)`   
Первая колонка - это интерцепт. Следовательно в модельной матрице "значимых" колонок `r ncol(X) - 1`.    
Вас не должно смущать, что количество колонок больше, чем количество предикторов в модели `~SubsDens + WatrCont + Substrate + Topo`.

Предикторы  `SubsDens и WatrCont`  - это непрерывные переменные, они дают по одной колонке в модельной матрице.  

Но! `Substrate и Topo` - это категориальные предикторы с `r length(levels(mite.env$Substrate))` и `r length(levels(mite.env$Topo))` градациями. При этом по одной из градаций обоих факторов уходит в базовый уровень модели.
Таким образом, в модельной матрице есть  2 колонки (от `SubsDens` и `WatrCont`) плюс (7 -1) колонок от `Substrate` плюс (2-1) колонок от `Topo`. Итого, 9 колонок!   

*Внимание!* Именно столько и будет канонических осей в ограниченной ординации.



##Строим матрицу предсказанных значений
Для этого надо будет решить следующее матричное уравнение

$$
\hat {\textbf Y}  = \boldsymbol {\beta \times  X}
$$

В нашем случае это будет матрица **Q_pred**



## Матрица коэффициентов 

$$
\boldsymbol{\beta} = \boldsymbol {[X'X]^{-1}X'Y}
$$

## Матрица остатков

$$
\boldsymbol {Y_{resid} = Y - \hat {Y}}
$$

В нашем случае это будет матрица **Q_resid**



## Вспомним важную особенность матрицы **Q**

Поскольку строки и столбцы матрицы **Q** равнозначны, то есть два равнозначных центроида: центроид строк (пробы) и центроид колонок(виды)

Координаты центроидов задаются векторами `p_i`(для строк) и `p_j`(для колонок)  

Для работы со строками надо учитывать вектор `p_i`

Для работы со столбцами надо учитывать вектор `p_j`




##Теперь все это на языке R

Матрица коэффициентов уравнения регрессии

$$
\boldsymbol{\beta} = \boldsymbol {[X'X]^{-1}X'Y} \\ 
\boldsymbol{\beta} = \boldsymbol{[X' p_i X]^{-1}[X'\sqrt{p_i} Q]}
$$



```{r, echo=TRUE}
#Матрица коэффициентов
betas <- solve(t(X) %*% diag(p_i) %*% X) %*% (t(X) %*% diag(p_i)^(1/2) %*% Q)
```

Обратите внимание, что для вычисления коэффициентов регрессии нам пришлось опять вводить в расчет маргинальные вероятности $p_i$. 

Это связано с природой матрицы **Q**. Эта матрица не является матрицей первичных данных, а является матрицей остатков от нулевой модели, описывающей отсутствие связи между столбцами и сроками. Поэтому все ее значения имеют смысл только по отношению к центроиду строк или по отношению к центроиду колонок.


## Теперь все это на языке R

Матрица предсказанных значений

$$
\boldsymbol{Q_pred} = \boldsymbol{\sqrt{p_i} X \beta}
$$

```{r, echo=TRUE}
 #Матрица предсказанных значенй
Q_pred <- diag(p_i)^(1/2) %*% X %*% betas
```



##SVD матрицы предсказанных значений

SVD матрицы предсказанных значений

```{r, echo=TRUE}
U_pred <- svd(Q_pred)$u 
D_pred <- diag(svd(Q_pred)$d)
V_pred <- svd(Q_pred)$v

```

`D_pred` - характеризует канонические (constrained) оси 

##Инерция в пространстве канонических осей

```{r}
Inertia_constrained <- sum(D_pred^2) #Инерция в ограниченной ординации

CCA_number <- sum(round(D_pred, 2) !=0) #Количество Канонических осей в СCA. 

```


Обратите внимание, в векторе сингулярных чисел `r CCA_number` ненулевых значений, то есть, как и обещали, ровно столько же, сколько колонок в модельной матрице **X** (без учета интерцепта).

Инерция в канонических осях составляет `r Inertia_constrained`.   

Можно оценить, сколько процентов составляет инерция канонических осей от общей инерции, полученной в CA (`r Inertia_total`).    

Итого, канонические оси отражают `r Inertia_constrained/Inertia_total * 100` %  общей изменчивости (инерции).   


##Матрица остатков 

Это разность между матрицей **Q** и **Q_pred**

```{r, echo=TRUE}
Q_resid <- Q - Q_pred

```

##SVD матрицы остатков

```{r, echo=TRUE}
U_res <- svd(Q_resid)$u 
D_res <- diag(svd(Q_resid)$d)
V_res <- svd(Q_resid)$v

```

Сингулярные числа в матрице **D_res** задают неканонические (unconstrained) оси


Число ненулевых сингулярных чисел в матрице **D_res** составляет `r sum(round(D_res, 2) !=0)`. То есть неканонических осей столько же сколько главных осей в корреспондентном анализе. То есть, на 1 меньше, чем в колонок в матрице **Q**.


## Инерция в пространстве неканонических осей

```{r, echo=TRUE}
#Инерция ординации остатков 
Inertia_unconstrained <- sum(D_res^2) 
```

Инерция в пространстве неканонических осей составляет: `r Inertia_unconstrained`, то есть неканонические оси объясняют `r Inertia_unconstrained/ Inertia_total *100` % общего варьирования (общей инерции) в системе.    

На всякий случай обратите внимание, что 
$$Inertia_{total} = Inertia_{constrained} + Inertia_{unconstrained}$$

```{r}
Inertia_unconstrained + Inertia_constrained
```



##Сравним то, что мы получили вручную с тем, что делает функция cca() из пакета vegan {.smaller .columns-2}

Вот то, что получено вручную     

Общая инерция, инерция в канонических осях и инерция в неканонических осях
```{r, echo=FALSE}
Inertia_total
Inertia_constrained
Inertia_unconstrained

```

Соответствующие доли 

```{r, echo=FALSE}
Inertia_total/Inertia_total
Inertia_constrained/Inertia_total
Inertia_unconstrained/Inertia_total

```

Собственные значения для канонических осей (квадраты сингулярных чисел из **D_pred**)
```{r, echo=FALSE}
round(diag(D_pred)^2, 4) [round(diag(D_pred)^2, 4) !=0]

```

Первые 8 собственных значений для канонических осей (квадраты сингулярных чисел из **D_res**)
```{r, echo=FALSE}
round(diag(D_res)^2, 5) [1:8]

```



##Сравним то, что мы получили вручную с тем, что делает функция cca() из пакета vegan

Вот то, что показывает `cca()`
```{r, echo=TRUE}
mite_cca <- cca(mite ~ SubsDens + WatrCont + Substrate + Topo, data = mite.env)
mite_cca
```


##Ординация проб в каннических (constrained) осях {.smaller} 

```{r, echo=TRUE}

#Координаты проб в канонических осях полученные вручную

constr_CA_samples <- diag(p_i^(-1/2))%*% U_pred
```

Пробы -- это строки, стало быть, опять маргинальная вероятность `p_i`  


```{r, echo=TRUE}
#Координаты проб в канонических осях по версии cca()

cca_ord <- mite_cca$CCA$u 

```

```{r, echo=FALSE, fig.height=2}
qplot(constr_CA_samples[ ,1], cca_ord[ ,1]) + geom_abline(slope = 1)

```


##Посмотрим на результаты ординации в первых двух канонических осях  {.columns-2}

```{r, echo=FALSE, fig.width=5}
library(ggplot2)
ggplot(as.data.frame(constr_CA_samples), aes(x=V1, y=V2)) + geom_text(label = rownames(mite)) + labs(x = "CCA1", y = "CCA2") + theme_bw() + geom_hline(yintercept = 0, linetype = 2) + geom_vline(xintercept = 0, linetype = 2) + ggtitle("Результаты, полученные вручную")

```


```{r, echo=FALSE, fig.width=5, fig.height=3}

plot(mite_cca, display = "lc", main = "Результаты сca()", scaling = "sites")
```


##Ординация видов в каннических (constrained) осях

```{r, echo=TRUE}

#Координаты видов канонических осях полученные вручную

constr_CA_species <- diag(p_j^(-1/2))%*% V_pred

```


Виды -- это колонки, стало быть, маргинальная вероятность `p_j`  



```{r, echo=TRUE}
#Координаты видов в канонических осях по версии cca()

cca_sp_constr <- mite_cca$CCA$v 

```



```{r, echo=FALSE, fig.height=2}
qplot(constr_CA_species[ ,1], cca_sp_constr[ ,1]) + geom_abline(slope = 1)

```


##Посмотрим на результаты ординации видов в первых двух канонических осях  {.columns-2}

```{r, echo=FALSE, fig.width=5}
library(ggplot2)
ggplot(as.data.frame(constr_CA_species), aes(x=V1, y=V2)) + geom_text(label = colnames(mite)) + labs(x = "CCA1", y = "CCA2") + theme_bw() + geom_hline(yintercept = 0, linetype = 2) + geom_vline(xintercept = 0, linetype = 2) + ggtitle("Результаты, полученные вручную")

```



```{r, echo=FALSE, fig.width=5}
plot(mite_cca, display = "sp", main = "Результаты сca()", scaling = "species")

```



# Интерпретация результатов CCA

##За какую долю изменчивости отвечают учтеные факторы?


- Часть изменчивости структуры сообществ орибатид действительно удается объяснить изменениями среды. Канонические оси объясняют 43% общей инерции если рассматривать всю изменчивость (т.е. 43 оси). Из них первые две оси объясняют 33 % общей изменчивости.

Но, если рассматривать первые две канонические оси в пределах только ограниченных осей (т.е. 9 осей) - то учтенные факторы среды объясняют целых 75%


## Распределение изменчивости, потенциально объяснимой факторами

```
Accumulated constrained eigenvalues
Importance of components:
                       CCA1  CCA2   CCA3   CCA4   CCA5   CCA6   CCA7 ...
Eigenvalue            0.426 0.129 0.0667 0.0443 0.0321 0.0145 0.0107 ...
Proportion Explained  0.580 0.175 0.0907 0.0603 0.0437 0.0197 0.0145 ...
Cumulative Proportion 0.580 0.755 0.8458 0.9061 0.9498 0.9695 0.9840 ...
```

- Первая ограниченная ось объясняет 58%, вторая 17% того, что можно потенциально связать с воздействием среды, остальные оси почти ничего не объясняют. Значит, характеристики среды, в принципе, можно свести к двум комплексным независимым переменным.


## Собственные векторы, нагрузки переменных = “species scores”

- обилие каких видов сильнее варьирует вдоль оси?

```{r eval=FALSE}
scores(mite_cca, display = "species", choices = 1:5)
```

## Другие части результатов

- Собственные векторы  (“species scores”) координаты видов
- Координаты объектов  (“site scores”) 
- Координаты объектов в канонических осях (“Site constraints”)
- (“Biplot scores”) координаты для биплотов
- Центроиды сайтов для бинарных переменных среды на диаграмме ординации (“Centroids for factor constraints”)

## Корреляции между откликами (обилиями видов) и предикторами (средой)

```{r}
spenvcor(mite_cca)
```

> - Несмотря на то, что канонические оси объясняют не очень большое количество изменчивости, почти все они сильно или умеренно коррелируют с характеристиками среды.


## Как реагируют отдельные виды на влияние предикторов? {.columns-2 .smaller}

Для каких видов ординация в канонических осях более значима, чем в неканонических осях. 

Разложение инерции на составляющие в отношении каждого вида.

```{r}
spec_inertia <- inertcomp(mite_cca, display = c("species"), 
                          statistic = c("explained"), 
                          proportional = FALSE )
spec_inertia <- as.data.frame(spec_inertia)
```

<br>
<br>

```{r, fig.width=5}
ggplot(spec_inertia, aes(x = CCA, y = CA)) + 
  geom_point() + geom_abline(slope = 1)
```



# Визуализация ординации


## Как можно изобразить результаты CCA?

Триплоты:

- переменные-отклики ("species"),
- объекты ("sites")
- переменные-предикторы (непрерывные в виде векторов, дискретные в виде центроидов)

Биплоты:

- отклики + предикторы
- объекты + предикторы


## Координаты на ординации

Осторожно, в CCA есть два типа координат объектов:

- WA - "weighted average scores" -  без ограничений переменными среды, но при этом они отличаются от координат полученных в CA

- LC - "linear combination scores" -  результат множественной регрессии WA-координат по линейным комбинациям переменных среды - это по-умолчанию используется в `vegan`


## Примеры триплотов {.columns-2 .smaller}


```{r tidy = FALSE, fig.width = 4, fig.height=4}
plot(mite_cca, scaling = "sites", 
     main = "scaling 1, или 'sites' ")
```

```{r tidy = FALSE, fig.width = 4, fig.height=4}
plot(mite_cca, scaling = "species", 
     main = "scaling 2, или 'species'")
```



## Отношения между видами и средой (scaling = 2, или "species") {.columns-2 .smaller}

```{r tidy = FALSE, fig.height=5, fig.width=5}
plot(mite_cca, scaling = 2, 
     display = c("species", "cn"), 
     main = "biplot cca, scaling 2")
```

- Проекция вида под прямым углом на стрелку-предиктор -- оптимум вида по этой переменной.

- Вид вблизи центроида качественной переменной -- скорее всего часто встречается на сайтах с такими качествами.

<!-- - Расстояния между центроидами и объектами __НЕ равны__ $\chi^2$ -->




## Отношения между объектами и средой (scaling = 1, или "sites") {.columns-2 .smaller}


```{r tidy = FALSE, fig.width = 5, fig.height=5 }
    plot(mite_cca, scaling = 1, 
     display = c("sites", "cn"), 
     main = "biplot cca, scaling 1")
```


- Проекция объекта под прямым углом на стрелку-предиктор - приблизительная позиция объекта вдоль градиента, связанного с данным предиктором.

- Объект вблизи центроида качественной переменной скорее всего обладает данным качеством.

<!-- - Расстояние между центроидами качественных переменных и между центроидами объектов - $\chi^2$ -->

# Проверка значимости ординации

## Общий тест на значимость ординации

- Тестируем гипотезу о том, что отношения между структурой сообщества и средой значимы - $H _0$: обилие видов в пробах не зависит от значений переменных среды

- основан на пермутациях: случайно перемешиваем данные и проверяем, насколько редко будет наблюдаться связь сильнее, чем данная

- статистика - сумма всех канонических собственных чисел

### Есть ли связь структуры сообщества со средой?

## Общий тест на значимость ординации {.smaller}

```{r, echo=TRUE}
anova(mite_cca)
```

> - Структура сообщества связана с условиями среды


## Тест факторов, type I эффекты: Какие факторы влияют на зависимые переменные?{.smaller}

> - Структура сообщества клещей зависит от плотности и типа субстрата, от содержания воды и топографии
- Осторожно, это Type I эффекты. Они зависят от порядка включения факторов в модель!

```{r, echo=TRUE}
anova(mite_cca, by="term")
```

## Тест факторов, type III эффекты: Какие факторы влияют на зависимые переменные?{.smaller}

>- Если протестировать каждый из факторов отдельно, при условии, что остальные уже в модели, получится, что тип субстрата не влияет, а влияют остальные факторы.

```{r, echo=TRUE}
anova(mite_cca, by="mar")
```

## Тест значимости осей, ограниченных факторами {.smaller}

- $H_0$: изменение состава сообщества в пробах вдоль данной оси не зависит от переменных среды

- пермутационный тест: случайно переставляем данные и проверяем, насколько редко данная ось (на пермутированном материале) объясняет больше изменчивости чем в исходном анализе. Если редко, то варьирование вдоль оси значимо

>- Структура сообщества значимо меняется вдоль первых 3 канонических осей

```{r, echo=TRUE}
anova(mite_cca, by="axis")
```


## Ограничения CCA

>- Может основываться только на неотрицательных величинах.
- Редкие виды - использовать когда репрезентативная выборка или удалить из анализа
- Чтобы снизить вес больших численностей видов - логарифмировать
- Доля объясненной изменчивости (% of total inertia) - аналогично $R^2$ - смещенная оценка. Простых поправок не придумано.
- Симметричные распределения переменных среды (преобразования)
- Нельзя включать шумные переменные среды 


## Summary

- Анализ наиболее применим для тех случаев, когда величины в зависимой матрице могут  трактоваться как частоты.

- Канонический корреспондентный анализ позволяет описать, как структура изменчивости многомерных данных определяется внешними переменными.

- Вычислительная часть CCA ничем не отличается вычислительной части CA, но в анализ  вовлекаются вместо одной матрицы **Q** две матрицы:   

- Матрица предсказанных линейной моделью значений **Q_pred** (дает канонические оси)   

- Матрица остатков **Q_res** (дает неканонические оси)   

- Вычисление матриц **Q_pred** и **Q_res** производится с использованием матричного способа подбора коэффициентов регрессии.   




## Дополнительные ресурсы

- Borcard, D., Gillet, F., Legendre, P., 2011. Numerical ecology with R. Springer.
- Jongman, R.H.G., Ter Braak, C.J.F., Van Tongeren, O.F.R. (eds.), 1995. Data analysis in community and landscape ecology. Cambridge University Press
- Legendre, P., Legendre, L., 2012. Numerical ecology. Elsevier.
- Oksanen, J., 2011. Multivariate analysis of ecological communities in R: vegan tutorial. R package version 2–0.
- The Ordination Web Page URL http://ordination.okstate.edu/ (accessed 10.21.13).
- Quinn, G.G.P., Keough, M.J., 2002. Experimental design and data analysis for biologists. Cambridge University Press.
