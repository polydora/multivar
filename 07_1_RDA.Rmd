---
title: "Анализ избыточности (Redundancy analysis, RDA)"
subtitle: "Анализ и визуализация многомерных данных с использованием R"
author: Марина Варфоломеева, Вадим Хайтов
presenters: [{
  name: 'Марина Варфоломеева',
  company: 'Каф. Зоологии беспозвоночных, СПбГУ',
  }]
output:
 ioslides_presentation:
  widescreen: true
  css: assets/my_styles.css
  logo: assets/Linmod_logo.png
---


```{r setup, include=FALSE, cache=FALSE, purl=FALSE}
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.align='center', tidy = FALSE, fig.width = 7, fig.height = 3, warning = FALSE)
```

## Анализ избыточности (Redundancy analysis, RDA)

- Связь нескольких наборов переменных
- Анализ избыточности, теория и практика
- Проверка значимости ординации
- Выбор оптимальной модели
- Частный анализ избыточности и компоненты объясненной инерции
- Компоненты объясненной изменчивости

### Вы сможете

- Проводить анализ избыточности
- Оценивать долю объясненной инерции
- Интерпретировать компоненты по нагрузкам переменных
- Строить ординацию объектов в пространстве компонент
- Проверять значимость модели ординации при помощи пермутационного теста
- Разделять объясненную инерцию на компоненты, связанные с разными наборами переменных, при помощи частного анализа избыточности


# Связь нескольких наборов переменных

## Что будет определять генетическую структуру в колониях бабочек?

### Пример: генетика бабочек _Euphydryas editha_

Частоты разных аллелей фосфоглюкоизомеразы и данные о факторах среды для 16 колоний бабочек _Euphydryas editha_ в Калифорнии и Орегоне (данные McKechnie et al., 1975)

<div class="columns-2">

```{r echo=FALSE, fig.height=4, fig.width=4, purl=FALSE}
library(ade4)
data(butterfly)
# расположение сайтов
s.label(butterfly$xy, contour = butterfly$contour, inc = FALSE)
```

<img src="images/WingedWonder-RogerLynn-Flickr.jpg" width=450>

Winged Wonder by [Roger Lynn on Flickr](https://flic.kr/p/6CMVsC)

</div>

# Анализ избыточности

## Анализ избыточности (RDA, Redundancy analysis)

- Метод прямой ординации (ограниченной ординации = constrained ordination)
- Основан на анализе главных компонент
- Нужно две матрицы данных: матрица зависимых переменных и матрица предикторов
- Нужно найти такие компоненты матрицы зависимых переменных, которые являются линейными комбинациями предикторов и отражают максимум изменчивости.

## Непрямая ординация и множественная регрессия

<img src="images/constrained1.png"  height=500px>

Рис. из Legendre, Legendre, 1998

## Прямая (ограниченная) ординация

<img src="images/constrained2.png" height=500px>

Рис. из Legendre, Legendre, 1998

## Если множественную линейную регрессию можно обобщить для нескольких зависимых переменных --- получится RDA

$$y _{i} = b _0 + b _1 x _{1i} + b _2 x _{2i} + ... + b _k x_{ki} + \epsilon _{i}$$

Уравнение множественной линейной регрессии можно переписать в виде матриц.

$$\left[\begin{array}{c}
y_1 \\ y_2 \\ \vdots \\ y_n 
\end{array}\right] = 
\left[\begin{array}{cc}
1 & x_{1,1} & x_{1,2} & \cdots & x_{1,k} \\
1 & x_{2,1} & x_{2,2} & \cdots & x_{2,k} \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
1 & x_{n,1} & x_{n,2} & \cdots & x_{n,k}
\end{array}\right] \cdot
\left[\begin{array}{c}
b _0 \\ b _1 \\  b _2 \\ \vdots \\ b _k
\end{array}\right] +
\left[\begin{array}{c}
\epsilon _1 \\ \epsilon _2 \\ \vdots \\ \epsilon _n
\end{array}\right]
$$

Сокращенная форма записи: $\mathbf{y} = \mathbf{X} \mathbf{b} + \mathbf{\epsilon}$, причем $\mathbf{b} = (\mathbf{X}^T\mathbf{X})^{-1}(\mathbf{X}^T \mathbf{y})$.

### Во множественной линейной регрессии $\mathbf{\hat y} = \mathbf{X}(\mathbf{X}^T\mathbf{X})^{-1}(\mathbf{X}^T\mathbf{y})$

### В RDA зависимая переменная --- матрица, т.е. $\mathbf{\hat Y} = \mathbf{X}(\mathbf{X}^T\mathbf{X})^{-1}(\mathbf{X}^T\mathbf{Y})$, 

## Принцип RDA {.columns-2}

<img src="images/RDA-principle.png" width=480px>
<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
<img src="images/RDA-principle1.png" width=480px>
Рис. из Legendre, Legendre, 1998

## Условия применимости RDA

- Независимость наблюдений (сайтов)
- Линейная зависимость переменных-откликов от предикторов
- Не должно быть мультиколлинеарности предикторов
- Сайтов должно быть значительно больше, чем предикторов (как в регрессии, см. "проклятие размерности")

# Подготовка данных к RDA

## Подготовка исходных данных

Нужно две матрицы: зависимые переменные (генетические данные для разных сайтов) и предикторы (данные об условиях среды, координатах и т.п.).

Структура исходных данных

- `$xy` --- координаты колоний
- `$envir` --- 4 фактора среды для колоний
- `$genet` --- частоты 6 аллелей в колониях
- `$contour` --- карта Калифорнии

```{r}
library(ade4)
data(butterfly)
str(butterfly)
```

## Создадим переменные с более короткими названиями для удобства

```{r}
gen <- butterfly$genet
head(gen, 1)
env_geo <- cbind(butterfly$envir, butterfly$xy)
head(env_geo, 1)
```

## Нужно ли стандартизовать зависимые переменные?

```{r}
summary(gen)
```

>- Нет, можно оставить так, т.к. масштаб не сильно различается

## Линейны ли связи между переменными?

```{r fig.width=7, fig.height=6}
pairs(env_geo)
```

## Удаляем коллинеарные предикторы

Не будем учитывать предикторы у которых VIF >= 10 (Borcard et al. 2011)

```{r}
library(car)
vif(lm(gen$`0.4` ~ ., data = env_geo))
vif(lm(gen$`0.4` ~ . -Temp_Min, data = env_geo))
```

>- Минимальная температура связана с высотой. Придется оставить что-то одно. Не будем использовать минимальную температуру.

<!-- ## Для анализа данных о сообществах при помощи RDA -->

<!-- ### Проверяем длину градиента при помощи detrended СА -->

<!-- Чтобы можно было пользоваться RDA, SD должно быть не больше 2-3. Если 4 --- это уже унимодальный градиент -->

<!-- ```{r} -->
<!-- decorana(gen) -->
<!-- ``` -->
<!-- Уменьшает ли трансформация Хеллингера длину градиента? Если сильно уменьшает, то лучше CCA -->

<!-- ```{r} -->
<!-- decorana(decostand(gen, "hellinger")) -->
<!-- ``` -->

# RDA в R

## RDA в vegan

- Зависимые переменные (отклики) --- генетические данные
- Независимые переменные (предикторы) --- переменные среды

```{r, message=FALSE}
library(vegan)
bf_rda <- rda(gen ~ Altitude + Precipitation + Temp_Max, data = env_geo)
summary(bf_rda) 
```


## Структура общей изменчивости

О структуре изменчивости можно судить __по суммам собственных чисел ординационных осей__ (ограниченных и неограниченных)

```{r echo=FALSE, purl=FALSE}
smr <- summary(bf_rda)

partit <- function(smr){
  if(!is.null(smr$partial.chi)){
    Inertia <- c(smr$tot.chi, smr$partial.chi, smr$constr.chi, smr$unconst.chi)
    nms <- c("Total", "Conditioned", "Constrained", "Unconstrained")
  } else {
    Inertia <- c(smr$tot.chi, smr$constr.chi, smr$unconst.chi)
    nms <- c("Total", "Constrained", "Unconstrained")
  }
  part <- data.frame(Inertia = round(Inertia, 2), Proportion = round(Inertia/smr$tot.chi, 3))
  rownames(part) <- nms
cat("Partitioning of variance:\n")
part
}

partit(smr)
```

- Total --- для всех осей, общая изменчивость исходной матрицы откликов (генетич. структуры в разных сайтах)
- Constrained --- для осей, кот. являются комбинациями предикторов (изменчивость объясненная средой)
- Unconstrained --- необъясненная предикторами изменчивость


## Важность различных компонент

Можно более подробно оценить, как распределяется изменчивость между осями

```{r echo=FALSE, purl=FALSE}
cat("Eigenvalues, and their contribution to the variance")
smr$cont
```

> - Много изменчивости объяснено, но много осталось необъясненной. Первые две ограниченных оси объясняют 51% изменчивости, но первые две неограниченных объясняют еще 43%


## Распределение изменчивости, потенциально объяснимой факторами

```{r echo=FALSE, purl=FALSE}
cat("Accumulated constrained eigenvalues")
smr$concont
```

> - Первая ограниченная ось объясняет большую часть потенциально объяснимой изменчивости. Остальные оси почти ничего не объясняют.


## Собственные векторы, нагрузки переменных = “species scores”

```{r}
scores(bf_rda, display = "species", choices = 1:5)
```

> - 

## Корреляции между откликами и предикторами

> - Сильная корреляция между генетической структурой и средой только для первой ограниченной оси. Для других --- умеренные или слабые.

```{r}
spenvcor(bf_rda)
```

# Визуализация ординации

## Визуализация ординации

- Какие предикторы важнее всего?
- Какими факторами определяется значение зависимых переменных?

### Триплоты:
  - переменные-отклики ("species"),
  - объекты ("sites")
  - переменные-предикторы (непрерывные в виде векторов, дискретные в виде центроидов)

### Биплоты:
  - отклики + предикторы
  - объекты + предикторы 



## Триплот корреляций (scaling = 2): Какие переменные среды сильнее всего определяют сходство объектов? {.columns-2}

```{r echo=FALSE, purl=FALSE}
op <- par(mar = c(2, 2, 0, 1))
```


```{r fig.width = 5, fig.height=4.5}
plot(bf_rda, scaling = 2)
```

- Векторы --- независимые переменные, факторы среды
- Надписи --- объекты (сайты, особи, популяции и пр.)
- Красные надписи ---- зависимые переменные

- Косинусы углов между векторами --- корреляции между соотв. переменными
- Расстояния между объектами не имеют конкретного смысла
- Проекция объекта на линию-вектор --- значение переменной для данного объекта


## Пример интерпретации триплота корреляций

```{r fig.width=5, fig.height=4.5}
plot(bf_rda, scaling = 2)
```

> - Вдоль первой оси изменяется температура, высота и осадки
- Вдоль второй оси --- немного меняется уровень осадков


## Триплот расстояний (scaling = 1): Насколько похожи друг на друга объекты? {.columns-2}


```{r fig.width = 5, fig.height=4.5}
plot(bf_rda, scaling = 1)
```

- Надписи --- объекты (сайты, особи, популяции и пр.)
- Красные надписи --- зависимые переменные
- Векторы --- независимые переменные, факторы среды

- Расстояния между точками --- расстояния между наблюдениями
- Косинусы углов между векторами предикторов и откликов --- корреляции между соотв. переменными, другие углы не имеют смысла
- Проекция объекта на линию-вектор отражает примерное относительное положение данного объекта вдоль соотв. переменной (но не значение)
- Отношения между дискретными и непрерывными предикторами не интерпретируются


## Пример интерпретации триплота расстояний

```{r fig.width=6, fig.height=4.5}
plot(bf_rda, scaling = 1)
```

> - Генетическая структура в LO и UO похожа, но не похожа на остальные места
- GL и GH --- более высокогорные сайты, чем LO и UO

```{r echo=FALSE, purl=FALSE}
par(op)
```

# Проверка значимости ординации

## Проверкить значимость ординации можно несколькими способами

Каждый из способов дает ответ на свой собственный вопрос.

### Влияют ли факторы на зависимые переменные?

общий тест значимости ординации

### Какие именно факторы влияют на зависимые переменные?

тест факторов по отдельности (Type I или Type III эффекты)

### Значима ли изменчивость вдоль осей ординации?

тест каждой из осей ординации

## Пермутационный тест

- Делаем случайную перестановку данных в матрице зависимых переменных
- Оцениваем качество модели. На основе сумм собственных чисел ограниченных и неограниченных осей рассчитываем статистику --- псевдо-F

$$pseudoF = \frac {\Lambda_{c} / p} {\Lambda_{r}/(n - p - 1)}$$

$\Lambda_{c}$ --- инерция ограниченных осей, а $\Lambda_{r}$ --- остаточная инерция (тогда $\Lambda_{c} + \Lambda_{r} = \Lambda$ --- общая инерция), $p$ --- ранг ограниченных осей, $n$ --- число наблюдений  
Псевдо-F построена по тем же принципам, что F в ANOVA, но не следует F-распределению (кроме единственного частного случая RDA c одной переменной). Поэтому нам нужны пермутации, чтобы оценить форму ее распределения.

- По распределению пермутационной статистики оцениваем долю пермутаций, в которых качество модели оказалось лучше, чем для реальной модели --- это доверительная вероятность $p$. Если в большинстве пермутаций получаются модели хуже, чем реальная модель, то значит зависимость от предикторов значима.


## Общий тест на значимость ординации

- тестируем гипотезу о том, что отношения между генотипом и средой значимы. 

$H _0$: значения предикторов в пробах не зависят от переменных среды (генетическая структура не зависит от среды)

## Общий тест: Влияют ли факторы на зависимые переменные?

### Есть ли связь генетики со средой?

```{r}
anova(bf_rda, permutations = 9999)
```

> - связь генетической структуры и среды значима


## Тест факторов, type I эффекты: Какие факторы влияют на зависимые переменные?

```{r}
anova(bf_rda, by = "term", permutations = 9999)
```

> - Генетическая структура популяций бабочек достоверно зависит от высоты, если в модель включены др. факторы. 
> - Но это Type I эффекты --- они зависят от порядка включения факторов в модель. Т.е. после включения высоты в модель другие факторы уже не влияют.


## Тест факторов, type III эффекты: Какие факторы влияют на зависимые переменные?

```{r}
anova(bf_rda, by = "mar", permutations = 9999)
```

> - Если протестировать каждый из факторов отдельно, при у словии, что все остальные включены в модель, то получится, что ни один из них не влияет.


## Тест значимости осей, ограниченных факторами: 

- $H _0$: значения переменных-откликов для объектов не зависят от переменных-предикторов
- пермутационный: выбирает оси, которые объясняют больше изменчивости, чем из др. матриц, полученных путем перестановок

## Тест значимости осей, ограниченных факторами: Вдоль какой из осей значимо меняется генетическая структура?

```{r}
anova(bf_rda, by = "axis", permutations = 9999)
```

> - Генетическая структура значимо меняется вдоль первой главной оси

# Выбор оптимальной модели

## Выбор оптимальной модели

У нас проблема. Если мы тестируем любой из факторов, после включения остальных в модель --- он не влияет. Это значит, что модель не оптимальна.

Как подобрать оптимальную модель?

> - Можно использовать пошаговый выбор модели: добавляем в модель лучшие переменные и снова исключаем те, что потеряли значимость. (Вспомните, как это было для регрессионных моделей.)

Какой можно использовать тест для сравнения моделей?

> - Модели с разным числом предикторов можно сравнить при помощи пермутационного теста (AIC для ограниченных ординаций не существует!)

> - __Осторожно!__
> - Пошаговый выбор модели --- не панацея, т.к. разные пошаговые методы могут дать разные конечные модели!
> - Не запихивайте в модель сразу все предикторы, а начинайте ваш выбор с небольшого числа важных факторов. 
> - В `vegan` факторы включенные в модель обозначаются "-", а факторы, исключенные из модели --- "+"

## Пошаговый выбор оптимальной модели

Для пошагового выбора нам понадобятся полная и нулевая модели

```{r}
m1 <-rda(gen ~ Altitude + Precipitation + Temp_Max, data = env_geo)
m0 <- rda(gen ~ 1, data = env_geo)
```

Запускаем пошаговый выбор

```{r}
m <- ordistep(m0, scope = formula(m1), permutations = 9999)
```


## Оптимальная модель, отобранная при помощи пошагового алгоритма

```{r}
m$anova
```

> - Оптимальная модель содержит только один предиктор --- высоту


# Частный анализ избыточности


## Зачем нужен __частный__ анализ избыточности?

Мы уже обнаружили тесную связь генотипов со средой, и даже знаем, с какими переменными. 

Но генотипы в близких местах могут быть похожи по разным причинам. 

И теперь у нас два вопроса:

### Кто виноват?

> - сходный климат в близких локациях
> - поток генов между близкими колониями облегчен

### Что делать?

> - Нужно удалить влияние географического положения, чтобы сделать корректный вывод о связи генотипов со средой.


## Частный анализ избыточности 

- зависимость от одного набора переменных (предикторов), когда влияние другого (ковариат) исключено. 

Техника:

1. Множественная регрессия зависимости предикторов от ковариат.

2. Остатки от этой регрессии --- это то, что от ковариат не зависит --- можно использовать в PCA в качестве предикторов (вместо исходных переменных среды).

<div class = "footnote">Legendre & Legendre 1998</div>


## Делаем частный RDA: зависимость генетической структуры от среды с учетом географического положения

```{r}
bf_prda_1 <- rda(gen ~ Altitude + Condition(x + y), data = env_geo)
anova(bf_prda_1, permutations = 9999) ## Пермутационный тест
```

> - Высота объясняет генетическую изменчивость, даже после удаления влияния географической близости


## График ординации

```{r fig.width=9, fig.height=5, results='hold'}
op <- par(mfrow = c(1, 2))
plot(bf_prda_1, main = "Correlation triplot", scaling = 2)
plot(bf_prda_1, main = "Distance triplot", scaling = 1)
par(op)
```

# Компоненты объясненной инерции

## Компоненты инерции

К этому моменту мы знаем, что среда объясняет генетическую изменчивость, даже после удаления влияния географических координат.

Но какая часть изменчивости генетической структуры объясняется в чистом виде географической близостью, а какая --- общим действием среды и географии?


## Общую инерцию делим на части

```{r varparts, echo=FALSE, fig.width=6, fig.height=1.6, purl=FALSE}
op <- par(mar = c(0, 0, 0, 0))
showvarparts(2, Xnames = c("Среда", "География"))
par(op)
```

| Компонент инерции | Что описывает? | Инерция |
| ---- | ---- | ---- |
| a + b + c | вся потенциально объяснимая средой и географией изменчивость | Объясненная ограниченными осями <br /> RDA среда + география |
| a | изменчивость, объясненная средой |  Объясненная ограниченными осями <br /> pRDA среда + Condition(география) |
| с | изменчивость, объясненная географией |  Объясненная ограниченными осями <br /> pRDA география + Condition(среда)  |
| b | изменчивость, совместно объясненная средой и географией | Находим инерцию по разности |

## Подбираем модели RDA, нужные для поиска компонентов инерции

```{r varparts, echo=FALSE, fig.width=6, fig.height=1.6, purl=FALSE}
```

Нам нужна __полная модель RDA: генетика от среды и географического положения__ (чтобы найти a + b + c)

У нас уже есть __частный RDA №1: зависимость генетики от среды с учетом географии__ (чтобы найти a)

Нам нужен __частный RDA №2: генетика от географии с учетом свойств среды__ (чтобы найти c)

```{r}
bf_prda_2 <- rda(gen ~ x + y + Condition(Altitude), data = env_geo)
bf_rda_full <- rda(gen ~ x + y + Altitude, data = env_geo)
```

## Задание: Найдите компоненты инерции

По результатам трех RDA найдите 

всю потенциально объяснимую инерцию,

а так же долю инерции, объясненную:

- средой и географией 
- средой, но не с географией
- географией, но не со средой

## Решение: 1) Сколько инерции потенциально объясняется средой и географией?

```{r}
sum_full <- summary(bf_rda_full)
```

```
> sum_full
```

```{r, echo=FALSE, purl=FALSE}
partit(sum_full)
```

Инерция, объясненная вместе средой и географией, здесь достаточно велика --- `r round(sum_full$constr.chi, 2)`

```{r}
(I_total <- sum_full$constr.chi)
```

В отличие от нее, доля инерции, объясненной ограниченной матрицей, может быть довольно малой по отношению к общей инерции, поэтому можно сосредоточиться на доле от потенциально объяснимой инерции (от `sum_full$constr.chi`)

## Решение: 2) Инерция, объясненная средой

```{r}
sum_prda_1 <- summary(bf_prda_1)
```
```
> sum_prda_1
```
```{r}
partit(sum_prda_1)
```

- Среда без географии объясняет `r round(sum_prda_1$constr.chi, 2)`

```{r}
(I_env <- sum_prda_1$constr.chi)
```


## Решение 3) Инерция, объясненная географией

```{r}
sum_prda_2 <- summary(bf_prda_2)
```
```
> sum_prda_2
```
```{r}
partit(sum_prda_2)
```

География без среды объясняет `r round(sum_prda_2$constr.chi, 2)`

```{r}
(I_geo <- sum_prda_2$constr.chi)
```


## Решение: 4) Инерция, совместно объясненная средой и географией

```{r}
(I_env_geo <- I_total - I_env - I_geo)
```


## Компоненты инерции --- сводим результаты вместе

```{r}
comp <- data.frame(Inertia = c(I_env, I_geo, I_env_geo, I_total))
rownames(comp) <- c('Только среда', 
                    'Только география', 
                    'Среда и география вместе', 
                    'Общая объяснимая инерция')
comp$Proportion <- comp$Inertia/sum(comp$Inertia[1:3]) * 100
colnames(comp) <- c('Инерция', '%')
comp
```

Среда объясняет 50% общей изменчивости генетической структуры --- очень много, но и география объясняет 30%. И только 21% объясняется совместным влиянием среды и географии


## Take home messages

- Анализ избыточности помогает установить связь между несколькими наборами переменных. Один из наборов считается зависимым, другой считается объясняющим
- Для анализа необходимо, чтобы зависимости переменных-откликов от предикторов были линейными
- В ходе анализа выделяют два типа осей --- ограниченные (объясненные) переменными-предикторами, и неограниченные (необъясненные) ими
- Частный анализ избыточности позволяет описать зависимость двух наборов переменных с поправкой на влияние дополнительных переменных (ковариат)
- При помощи частного анализа избыточности можно выделить компоненты инерции связанные с несколькими (2--4) наборами переменных-предикторов


## Дополнительные ресурсы

- Borcard, D., Gillet, F., Legendre, P., 2011. Numerical ecology with R. Springer.
- Legendre, P., Legendre, L., 2012. Numerical ecology. Elsevier.
- Oksanen, J., 2011. Multivariate analysis of ecological communities in R: vegan tutorial. R package version 2–0.
- The Ordination Web Page URL http://ordination.okstate.edu/ (accessed 19.04.17).
- Quinn, G.G.P., Keough, M.J., 2002. Experimental design and data analysis for biologists. Cambridge University Press.
