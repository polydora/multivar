---
title: "Знакомство с многомерными данными"
subtitle: "Анализ и визуализация многомерных данных с использованием R"
author: Вадим Хайтов, Марина Варфоломеева
presenters: [{
  name: 'Вадим Хайтов',
  company: 'Каф. Зоологии беспозвоночных, СПбГУ',
  }]
output:
 ioslides_presentation:
  widescreen: true
  css: assets/my_styles.css
  logo: assets/Linmod_logo.png
---

## Вы сможете

- Объяснить почему для некоторых задач больше подходят многомерные даные
- Объяснить суть понятия "многомерое пространство признаков"
- Представить многомерые данные в виде матриц описания значений признаков для объектов 
- Оценить сходство/различие между объектами с помощью специальных коэффициентов
- Описать _взаиморасположение_ объектов многомерном пространстве признаков с помощью матриц
- Визуализировать взаиморасположение объектов с помощью простейших методов

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.align='center', tidy = FALSE, fig.width = 7, fig.height = 3, warning = FALSE)
```


# Общая характеристика многомерных методов 

## Почему нужны многомерные методы?

Пусть у нас меется две группы объектов, у которых мы изучили некий признак. Мы хотим тестировать гипотезу о том, что эти две группы различаются.  

Вспомним логику тестирования гипотез.

```{r, echo = FALSE, fig.align = 'center'}
dat <- data.frame(trait = c(rnorm(100, 10,1), rnorm(100, 15, 1)), object = rep(c("a","b"), each = 100))
library(ggplot2)
theme_set(theme_bw(base_size = 14))
ggplot(dat[1:100,], aes(x = trait)) + geom_histogram(binwidth = 0.5, color = "black", fill = "blue") + xlab("Character") + theme_bw() + geom_histogram(data = dat[101:200,], aes(x = trait), binwidth = 0.5, color = "black", fill = "red") + ggtitle("Character distribution ")
```


## Почему нужны многомерные методы?

Теперь представим, что наш объект, по своей природе, не может быть описан только по одному признаку

- Сообщества (признаки - виды)
- Форма тела (признаки - размеры тех или иных частей)
- Социальная активность животного (признаки - проявление того или иного паттерна)
- Общественное мнение (признаки - ответы на разные вопросы анкет)
- Транскриптом (признаки - транскрипты)


## Почему нужны многомерные методы?

Предположим, что объекты характеризуются только двумя признаками 

```{r, echo = FALSE, fig.height=5}
ax <- rnorm(100, 10, 1)
ay <- 7*ax + rnorm(100, 0, 5)

bx <- rnorm(100, 11, 1)
by <- -0.5*bx + 70 + rnorm(100, 0, 3)

dat <- data.frame(x = c(ax, bx), y = c(ay, by), object = rep(c("a","b"), each = 100))

pl1 <- ggplot(dat, aes(x = x, y = y)) + geom_point(aes(color = object), size = 3) + xlab("Character 1") + ylab("Character 2") + theme_bw() + guides(color = F) + scale_color_manual(values = c("blue", "red"))

pl2 <- ggplot(dat, aes(x = x)) + geom_histogram(binwidth = 0.5, color = "black", fill = "gray") + xlab("Character 1") + theme_bw()

pl3 <- ggplot(dat, aes(x = y)) + geom_histogram(binwidth = 3, color = "black", fill = "gray") + xlab("Character 2") + theme_bw()

library(gridExtra)

grid.arrange(pl1, pl2, pl3, ncol = 2)

```


## Какие задачи решаются методами могомерной статистики?

>- Выявление взаимоотношений (сходства-различия) между объектами (или признаками): 
    - Классификация (Кластерный анализ)
    - Ординация. В том числе картирование пространственно выраженных объектов (nMDS, PCA, RDA).
- Тестирование гипотез о различиях между группами объектов (ANOSIM, PERMANOVA).
- Выявление  связи между группами признаков (тест Мантела, BIOENV, CCA).


## Признаки и объекты 

Данные представляются в виде таблицы (матрицы), где строками являются обекты (Objects), а столбцами признаки (Descriptors).


## R и Q анализы 


![R и Q](images/R Q analysis.png)

- R-анализ: Выясняем взаимоотношения между признаками
- Q-анализ: Выясняем взаимоотношения между объектами

## Геометрическая интерпретация Q-анализа

- Признаки - оси
- Объекты - точки  

```{r, echo = FALSE, fig.height=5}
library (scatterplot3d) 

dat$z = c(rnorm(100, 11, 1), rnorm(100, 14, 1))

scatterplot3d(x = dat$x, y = dat$z, z = dat$y, xlab = "Descriptor 1", ylab = "Descriptor 2", zlab = "Descriptor 3", color = rep(c("red","blue"), each = 100), pch = 21)
```


## Описание расположения объектов в многомерном пространстве признаков 

В большинстве случаев нас интересуют не абсолютные значения координат (признаков), а _взаиморасположение_ точек в многомерном пространстве.

Существует два основных способа описания.


## Способ 1. Геометрическое описание (линейная алгебра) {.smaller .columns-2}

```{r, echo = FALSE, fig.width = 5, fig.height=5, warning=FALSE}
dat2 <- data.frame(object = c("Object 1", "Object 2", "Object 3", "Object 4" ), x = c(2, 2, 4, 2.5), y = c(5, 10, 8, 4))

library(ggrepel)

pl4 <- ggplot(dat2, aes(x = x, y = y)) + geom_point(size = 5, color = "red") + xlim(0,5) + ylim(0, 11) + annotate(geom = "segment", x = 0, y = 0, xend = 2, yend = 5, arrow = arrow(type = "closed", angle = 20, ends = "last"), size = 1) + annotate(geom = "segment", x = 0, y = 0, xend = 2, yend = 10, arrow = arrow(type = "closed", angle = 20, ends = "last"), size = 1) + geom_text_repel(aes(label = object)) + annotate(geom = "text", x = 1, y = 2, label = "LV 1", angle = 0) + annotate(geom = "text", x = 1, y = 6, label = "LV 2", angle = 0) + annotate(geom = "text", x = 1, y = 3.3, parse = TRUE, label = "alpha", size = 10, angle = 0)

pl5 <- ggplot(dat2, aes(x = x, y = y)) + geom_point(size = 5, color = "red") + xlim(0,5) + ylim(0, 11) + geom_segment(aes(x = 0, y = 0, xend = x, yend = y), arrow = arrow(type = "closed", angle = 20, ends = "last"), size = 1) + geom_segment(aes(x = 0, y = 0, xend = 2, yend = 10), arrow = arrow(type = "closed", angle = 20, ends = "last"), size = 1) + geom_text_repel(aes(x = x, y = y+0.5), label = dat2$object)

grid.arrange(pl4, pl5, nrow = 2)
```

Для описания взаморасположения точек необходимо иметь два набора данных  
 
Матрицу углов между векторами (косинусов углов)

$$\begin{pmatrix}
\alpha_{11} & \alpha_{12} & \cdots & \alpha_{1n} \\
\alpha_{21} & \alpha_{22} & \cdots & \alpha_{2n} \\    
\vdots & \vdots & \ddots & \vdots \\
\alpha_{n1} & \alpha_{n2} & \cdots & \alpha_{nn}
\end{pmatrix}$$

Ряд длин векторов
$$\begin{vmatrix} LV1 \\ LV2 \\ ... \\ LVn \end{vmatrix}$$

Этот способ описания, с разными вариациями, будет применяться в методах _PCA, CCA, RDA_


## Способ 2. Через вычисление матрицы попарных расстояний (Similarity/Dissimilarity matrix) {.smaller .columns-2}


```{r, echo = FALSE, fig.width = 5}
pl6 <- ggplot(dat2, aes(x = x, y = y)) + geom_point(size = 5, color = "red") + theme_bw() + xlim(0, 5) + ylim(0, 11) + geom_text(aes(x = x, y = y+0.5), label = dat2$object) 

for ( i in 1:nrow(dat2)) for (j in i:nrow(dat2)) pl6 <- pl6 + geom_segment(x = dat2$x[i], y = dat2$y[i], xend = dat2$x[j], yend = dat2$y[j], arrow = NULL, size = 1) 

pl6
```

В анализ вовлекается матрица попраных расстояний (сходств) между объектами. Эта матрица однозначно описывает взаиморасположение между объектами.  

Этот способ представления взаиморасположения лежит в основе _Иерархического кластерного анализа, MDS, теста Мантела, ANOSIM, PERMANOVA, процедуры BIOENV_


## Три способа изображения матрицы расстояний

```{r, echo = FALSE}
round(dist(dat2[,-1], diag = TRUE, upper = TRUE), 1)

round(dist(dat2[,-1], diag = TRUE, upper = F), 1)

round(dist(dat2[,-1], diag = F, upper = F), 1)

```

Количество чисел в треугольной матрице сходства/различия:

$$N = \frac{n^2 - n}{2}$$ 

## Матрица расстояний в развернутом виде (Unfolded similarity/dissimilarity matrix)  

```{r,echo = FALSE}
round(dist(dat2[,-1], diag = F, upper = F), 1)
as.vector(round(dist(dat2[,-1], diag = F, upper = F), 1))
```


# Меры сходства и различия между объектами (Resemblance coefficients)

## Кто что ест? Потребление белка разного происхождения в Европе {.columns-2}

9 признаков 25 объектов:

- Country: Страна
- RdMeat: Красное мясо
- WhMeat: Белое мясо
<li style="break-before:column;color:red">Eggs: Яйца</li>
- Milk: Молоко
- Fish: Рыба
- Cereal: Зерновые культуры
- Starch: Крахмал-содержащая пища
- Nuts: Бобовые, орехи и масличные культуры
- Fr&Veg: Фрукты и овощи 


![Paleo Diet by zsoolt](images/PaleoDiet-zsoolt-Flickr.jpg)

Paleo Diet by zsoolt on [Flickr](https://flic.kr/p/pPK1nz)


## Читаем данные

```{r}
protein <- read.table("data/Protein.txt", header = TRUE, sep = "\t")
head(protein)
```

## Подготовка данных для анализа

Переменные могут быть измерены в разных шкалах

- численность, биомасса и проективное покрытие организмов   
- температура воды, соленость и концентрация биогенов   
- Размеры частей тела, количество частей тела, площадь частей тела   

Для таких случаев необходима стандартизация величин.  
Этот прием наиболее важен для геометрического способа представления многомерных данных.

$$x_{stand} = \frac{x_i - \bar{x}}{\sigma_x}$$

>- **Вопрос:** Какими свойcтвами обладают стандартизованные величины? 
- Среднее зачние равно нулю.
- Среднеквадратичное отклонение равно единице.


## Подготовка данных для анализа

В ряде случаев (особенно в экологических исследованиях) необходимо перевести абсолютные значения в относительные (доли от суммы или от максимума)

$$x_{rel} = \frac{x_i}{\sum x_i} \times 100 \%$$   

$$x_{rel} = \frac{x_i}{max(x_i)} \times 100 \%$$


## Подготовка данных для анализа {.smaller}

Часто возникает ситуация, когда один признак (или несколько прзнаков) имеет существенно более высокие абсолютные значения, чем все остальные.   

```{r, echo = FALSE, fig.width = 7, fig.height=3.5}
scatterplot3d(x = protein$Eggs, y = protein$Cereals, z = protein$Fish, scale.y = 3, pch = 21, xlab = "Eggs", ylab = "Cerials", zlab = "Fish")
```

В такой ситуации необходима _трансформация_ , которая "уравнивает" силу влияния признаков.

По силе эффекта трансформирующие функции распределяются так:

Отсутствие трансформации $\Rightarrow$ Квадратный корень $\Rightarrow$ Корень четвертой степени $\Rightarrow$ Логарифм $log(x_i +1)$ $\Rightarrow$ Присутствие отсутствие (1, 0)  


## Задание:

На основе датасета `protein` создайте матрицу, содержащую относительные величины (доли протеина каждого типа в общей количестве потребляемых протеинов)

Hint: Воспользуйтесь функцией `apply()`

## Решение

```{r}
total <- apply(protein[, -1], MARGIN = 1,FUN = sum)
protein_stand <- protein[, -1] / total
protein_stand$Country <- protein$Country

head(protein_stand)
```


## Наиболее частые коэффиценты сходства/различия и расстояния

Знакомимся с пакетом `{vegan}` (Oksanen et al., 2015)

```{r, echo=FALSE, message=FALSE}
library (vegan)
vegdist(protein[, -1], method = "euclidian")
```


## Сходства и различия

- Сходство (S) достигает максимума, когда объекты обладают идентичными признаками, 
различиe (D), наоборот - достигает минимума.

- Обычно (но не всегда) коэффииенты сходства распределены от 0 до 1.  
- Тогда $D = 1 - S$, или $D = \sqrt{1 - S}$, или $D = \sqrt{1-S^2}$.
- Показатели расстояния можно нормировать. $D_{norm} = \frac{D}{D_{max}}$, или $D_{norm} = \frac{D - D_{min}}{D_{max} - D_{min}}$.


## Проблема двойных нулей (Double zeros probem)

```{r, echo = FALSE}
dat5 <- (data.frame(Descriptors = c("D1", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "D9", "D10"), Object1 = c(0, 0, 0, 0, 0, 0, 0, 2, 2, 1), Object2 = c(0, 0, 0, 0, 0, 4, 5, 0, 0, 1)))

dat6 <- data.frame(t(dat5[,-1]))
names(dat6) <- dat5$Descriptors
dat6
```

О чем говорит то, что признаки D1, D2, D3, D4, D5 не были отмечены у двух объектов? 

- Вариант 1. Это ничего не означает.   
- Вариант 2. Отсутствие признака - дополнительное сходство между объектами.

От ответа на этот вопрос зависит какой коэффициент выбрать. 


## Два типа коэффициентов

Меры сходства/различия не учитывающие двойные нули. Эти коэффициенты не изменяются если в данные будут добавлены двойные нули (например, при увеличеннии количества описанных объектов). 

Примеры: 

- Евклидово расстояние
- расстояние по Манхеттену.  

Меры сходства/различия учитывающие двойные нули. Эти коэффициенты изменяются при появлении двойных нулей. Сходство возрастает за счет того, что отсутсвие признака считается тоже сходством. 

Пример: 

- Коэффициенты корреляции.



## Меры расстояния, или метрики

Свойства: 

- Если $a = b$, то $D(a, b) = 0$  
- Симметричность $D(a, b) = D(b, a)$  
- Справедливо неравество треугольника $D(a,b) + D(b,c) \geq D(a,c)$  

## Наиболее популярные меры расстояния

_Важно:_ метрики неадекватно оценивают степень различия при большом количестве нулей.Очень чувствительны к выбросам.

<div class = "columns-2">

**Нестандартизованные**

- Евклидово расстояние:

$$D = \sqrt{\sum(x_{i,j} - x_{i,k})^2}$$

- Расстояние по Манхеттену (Manhattan metric, taxicab metric, city-block metric):

$$D = \sum \mid x_{i,j} - x_{i,k} \mid$$

<br /><br /><br /><br /><br /><br /><br />

**Стандартизованные**

Удобнее так как признаки могут быть измерны в разных шкалах

- Расстояние по Канберре (Canberra metric):

$D = \frac{1} {p} \sum \frac {\mid x_{i,j} - x_{i,k} \mid} {x_{i,j}+ x_{i,k}}$

- Расстояние $\chi^2$

$\chi^2 = \sqrt{ \sum {\frac{1}{c_i}} (x_{i,j} - x_{i,k})^2}$ 

- Евклидово расстояние, вычисленное по относительным величинам.

</div>

## Неметрические коэффициенты сходства/различия (Similarity/Dissimilarity) 

- Корреляция Браве-Пирсона: 
$$ R = \frac {cov(X, Y)}{\sqrt{\sigma_x^2\sigma_y^2}} $$  

Коэффициент Браве-Пирсона варьирует от -1 до 1.

Обычно используется в R анализе

- Коэффициент Брея-Куртиса (Bray-Curtis dissimilarity): 
$$D = \frac{\sum \mid x_{i,j} - x_{i,k} \mid} {\sum x_{i,j} + \sum x_{i,k}}$$ 

Это самый распространенный в экологии коэффициент.


## Коэффициенты для бинарных данных  

В основе лежит четырехпольная таблица 

$$\begin{vmatrix} \, & + & - \\ + & a & b \\ - & c & d \end{vmatrix}$$

- a - сходство объектов по наличию признака
- b - различие
- c - различие
- d - сходство по отсутствию признака


## Коэффициенты для бинарных данных 


- Доля несовпадений: 

$$D = \frac{b+c}{a+b+c}$$ 

- Коэффициетт Жаккара: 

$$S = \frac{a}{a+b+c}$$

- Коэффициент Сёренсена:

$$S = \frac{2a}{2a + b + c}$$

_NB!_ Коэффициент Сёренсена - это коэффициент Брея-Куртиса, вычисленный для значений, оцененных как 1 или 0.


## Коэффициенты для бинарных данных 

- $\phi$-корреляция Пирсона

$$\phi = \frac{ad-bc}{(a+b)(c+d)(a+c)(b+d)}$$ 

Используется в R-анализе

<br /><br /><br /><br /><br /><br /><br /><br /><br />

## Коэффициент Говера 
 

Обобщенный коэффициент, который применяется для случаев, когда одни признаки объекта описаны, как количественные величины, а другие - как бинарные данные (или даже качественные даные).


$$ D = \frac{1}{p} \frac{\sum W_i\dfrac{\mid x_{i,j} - x_{i,k} \mid}{\max x_{i,j} - \min x_{i,k}}}{\sum W_i}$$

$W_i$ = 0 Если отсутсвует информация o $x_{i,j}$ и/или $x_{i,k}$ отсутствует  
$W_i$ = 1 Если присутсвует информация как о $x_{i,j}$ так и о $x_{i,k}$


## Отчего зависит выбор коэффициента? 

1. От природы материала (признаки могут иметь количественную, бинарую и качественную оценку).
2. От характера тестируемой гипотезы (какой аспект природы сходства-различия хочет выразить автор).
3. В экологии: от того, насколько мы хотим учитывать вклад редких и малочисленных видов.
4. От взглядов исследователя на природу сходства/различия между объектами.
5. От типа анализа (R или Q)

## Многие показатели взаимосвязаны и, часто, взаимозаменяемы

```{r}
BCD <- as.vector(vegdist(protein[,-1], method = "bray"))
ED <- as.vector(vegdist(protein[,-1], method = "euclidean"))

distances <- data.frame(Bray = BCD, Euclid = ED)
ggplot(distances, aes(x = Euclid, y = Bray)) + geom_point() + theme_bw()
```

##Какую информацию мы можем извлечь из матрицы расстояний?

Самый простой анализ - частотное распределение расстояний    
Позволяет понять есть ли сгущения в облаке точек в n-мерном пространстве признаков 

```{r, message=FALSE}
ggplot(distances, aes(x = Euclid)) + stat_density(adjust = 1/4, geom = "area", fill = "blue", color = "black")
```


##Какую информацию мы можем извлечь из матрицы расстояний?

Для более детального извлечения информации из матрицы расстояний необходимо перейти к рассмотрению техники ординации.    



## Summary

>- Существует два подхода к анализу многоменых данных:
    -  подход, основанный на линейной алгебре,
    -  подход, основанный на исследовании матриц сходства/различия между объектами.
- Выбор коэффициентов сходств/различия - непростая задача, решение которой зависит от структуры материала и поставленных задач. Разные коэффициенты потенциально могут давать разные результаты. 
- Получить важную информацию о взаиморасположении объектов можно с помощью некоторых простейших методов. 


## Что почитать 

* Legendre P., Legendre L. (1998) Numerical ecology. Second english edition. Elsevier, Amsterdam. (Фундаментальный труд, описывающий большинство методов. Дается исчерпывающее обсуждение разнообразных коэффициентов сходства/различия)
* Zuur, A. F., Ieno, E. N., Smith, G. M. Analysing Ecological Data. Springer 2007 (Практичеки все то же самое, что в L&L, но написанное простым языком)
* Clarke, K. R., Gorley R. N. (2006) PRIMER v6: User Manual/Tutorial. PRIMER-E, Plymouth. (Очень доходчиво написанное руководство, дающее общее представление о "механике" работы многомерных методов)
* Миркин Б.М., Розенберг Г.С. Фитоценология. Принципы и методы. М., 1978. (Руководство написано в докомпьютерную эпоху, но простейшие методы изложены очень хорошо)
* Василевич В.И. Статистические методы в геоботанике. - Л.: Наука, 1969.
* Дюран Б., Оделл П. Кластерный анализ. М.: Статистика, 1977
